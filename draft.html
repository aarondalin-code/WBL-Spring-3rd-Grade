<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draft • WBL 3rd Grade 2026</title>

  <link rel="stylesheet" href="./styles.css?v=wbl2026-draft-11" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    .draftPage .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      font-size:12px; font-weight:800;
      background: rgba(255,255,255,.8);
      white-space:nowrap;
    }
    .draftPage .pill.good{ border-color: rgba(0,150,80,.35); }
    .draftPage .pill.warn{ border-color: rgba(200,120,0,.45); }
    .draftPage .pill.bad { border-color: rgba(190,40,40,.45); }

    .draftPage .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .draftPage .grid2{ grid-template-columns: 1fr; } }

    .draftPage .smallMuted{ font-size:12px; color: rgba(0,0,0,.55); font-weight:700; }
    .draftPage .bigLine{ font-weight:1000; }

    /* Center and “pop” the clock */
    .draftPage .clockLine{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:baseline; justify-content:center; text-align:center;
    }
    .draftPage .clockLine > div{ width:100%; }
    .draftPage #onClock{ font-size:28px; font-weight:1000; }
    @media (max-width: 520px){ .draftPage #onClock{ font-size:22px; } }

    .draftPage .tightRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .draftPage .tightLeft{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .draftPage .tightName{ font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .draftPage .tightMeta{ display:flex; flex-wrap:wrap; gap:6px; }

    .draftPage .playerRow{ position:relative; cursor:pointer; }
    .draftPage .hoverCard{
      display:none;
      position:absolute;
      left:0; top:100%;
      margin-top:10px;
      width:min(860px, 92vw);
      background:#fff;
      border:1px solid rgba(0,0,0,.14);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 14px 32px rgba(0,0,0,.14);
      z-index: 50;
    }
    @media (hover:hover) and (pointer:fine){
      .draftPage .playerRow:hover .hoverCard{ display:block; }
    }

    .draftPage .k{ color:#1e40af; font-size:12px; font-weight:900; }
    .draftPage .v{ color: rgba(0,0,0,.88); font-size:12px; }
    .draftPage .na{ color: rgba(0,0,0,.45); font-style:italic; }

    /* 3-column fixed layout for hover + modal details */
    .draftPage .kv3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px 18px;
    }
    @media (max-width: 980px){ .draftPage .kv3{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px){ .draftPage .kv3{ grid-template-columns: 1fr; } }

    .draftPage .kvCol3{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap: 8px 12px;
    }
    @media (max-width: 520px){ .draftPage .kvCol3{ grid-template-columns: 140px 1fr; } }

    .draftPage .modalBackdrop{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      z-index: 1000;
      padding: 18px;
    }
    .draftPage .modalBackdrop.open{ display:flex; align-items:flex-start; justify-content:center; }
    .draftPage .modalCard{
      width:min(920px, 96vw);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.16);
      box-shadow: 0 18px 50px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .draftPage .modalHdr{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(0,0,0,.10);
    }
    .draftPage .modalTitle{ font-weight:1000; }
    .draftPage .modalBody{ padding:14px; }
    .draftPage .xBtn{
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.9);
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }

    /* -----------------------------
       FILTER BOX (NEW LAYOUT/POLISH)
       ----------------------------- */

    /* Make the filters card tighter and nicer */
    .draftPage .filtersCard .cardBody{
      padding:12px;           /* tighter vertical */
    }

    /* Watermark / design feature inside filter box */
    .draftPage .filtersShell{
      position:relative;
      border-radius:14px;
      padding:10px;           /* inner padding */
      background:
        linear-gradient(180deg, rgba(30,64,175,.06), rgba(30,64,175,0) 55%),
        repeating-linear-gradient(135deg,
          rgba(30,64,175,.045) 0px,
          rgba(30,64,175,.045) 10px,
          rgba(30,64,175,0) 10px,
          rgba(30,64,175,0) 28px
        );
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      overflow:hidden;
    }

    /* Optional subtle watermark text */
    .draftPage .filtersShell::after{
      content:"DRAFT ROOM";
      position:absolute;
      right:14px;
      top:10px;
      font-weight:1000;
      letter-spacing:.18em;
      font-size:12px;
      color: rgba(30,64,175,.22);
      transform: rotate(-6deg);
      pointer-events:none;
      user-select:none;
      text-transform: uppercase;
    }

    /* Filter layout: fixed 5 + 4 */
    .draftPage .filtersWrap{
      display:grid;
      gap:10px;
    }

    .draftPage .filtersGrid5{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      align-items:end;
    }
    .draftPage .filtersGrid4{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      align-items:end;
    }

    /* Responsive fallback */
    @media (max-width: 980px){
      .draftPage .filtersGrid5{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .draftPage .filtersGrid4{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .draftPage .filtersGrid5{ grid-template-columns: 1fr 1fr; }
      .draftPage .filtersGrid4{ grid-template-columns: 1fr 1fr; }
    }

    .draftPage .field{
      display:flex; flex-direction:column; gap:5px; min-width:0;
    }
    .draftPage .field .lbl{
      font-size:12px; font-weight:900; color: rgba(0,0,0,.55);
    }

    .draftPage input[type="text"], .draftPage select{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      font-size:14px;
    }

    /* Search + buttons in one row */
    .draftPage .actionsRow{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:10px;
      align-items:center;
      margin-top:2px;
    }
    @media (max-width: 720px){
      .draftPage .actionsRow{
        grid-template-columns: 1fr;
      }
      .draftPage .actionsRow .btnGroup{
        justify-content:stretch;
      }
    }

    .draftPage .btnSecondary{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }
    .draftPage .btnGroup{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      align-items:center;
    }

    /* Remove extra vertical space from meta line spacing under filters */
    .draftPage #meta{
      margin-top:8px !important;
    }
  </style>
</head>

<body class="watermarkPage draftPage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="siteNav">
      <span></span><span></span><span></span>
    </button>
    <div class="navOverlay" aria-hidden="true"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Draft Board</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">

    <div class="card filtersCard">
      <div class="cardBody">
        <div class="filtersShell">
          <div class="filtersWrap">

            <!-- Row 1: 5 filters -->
            <div class="filtersGrid5">
              <div class="field">
                <div class="lbl">Pitcher</div>
                <select id="pitcherFilter">
                  <option value="">All</option>
                  <option value="y">Pitcher (Y)</option>
                  <option value="n">Not marked</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Travel</div>
                <select id="travelFilter">
                  <option value="">All</option>
                  <option value="y">Travel (Y)</option>
                  <option value="n">Non-travel (N)</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Travel Level</div>
                <select id="levelFilter">
                  <option value="">All</option>
                  <option value="a">A</option>
                  <option value="b">B</option>
                  <option value="c">C</option>
                  <option value="none">None</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">School</div>
                <select id="schoolFilter">
                  <option value="">All</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Taken team</div>
                <select id="takenTeamFilter">
                  <option value="">All teams</option>
                </select>
              </div>
            </div>

            <!-- Row 2: 4 filters -->
            <div class="filtersGrid4">
              <div class="field">
                <div class="lbl">Spring Pitching</div>
                <select id="springPitchingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Spring Hitting</div>
                <select id="springHittingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Spring Throwing</div>
                <select id="springThrowingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Spring Fielding</div>
                <select id="springFieldingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>
            </div>

            <!-- Row 3: Search + buttons (horizontal) -->
            <div class="actionsRow">
              <div class="field" style="gap:0;">
                <input id="q" type="text" placeholder="Search player name…" />
              </div>

              <div class="btnGroup">
                <button id="clearBtn" class="btnSecondary" type="button">Clear filters</button>
                <button id="refreshBtn" class="btnSecondary" type="button">Refresh</button>
              </div>
            </div>

          </div>
        </div>

        <div class="smallMuted" id="meta" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="cardBody">
        <div class="clockLine">
          <div>
            <div class="bigLine">
              On the clock: <span id="onClock">—</span>
              <span class="pill" id="pickPill">Pick —</span>
            </div>
            <div class="smallMuted">
              Up next: <span id="upNext">—</span>
              • Round: <span id="round">—</span> / <span id="totalRounds">12</span>
              • Picks made: <span id="picksMade">0</span>
            </div>
            <div class="smallMuted" id="forfeitLine" style="margin-top:6px;"></div>
          </div>
          <div class="smallMuted">Auto-refresh: <span id="autoRefreshState">ON</span></div>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:14px;">
      <div class="card">
        <div class="cardBody">
          <h2 style="margin:0 0 10px 0;">Available</h2>
          <div id="available" style="display:grid; gap:10px;"></div>
          <p id="availMsg" class="smallMuted" style="margin-top:10px;"></p>
        </div>
      </div>

      <div class="card">
        <div class="cardBody">
          <h2 style="margin:0 0 10px 0;">Taken (by team)</h2>
          <div id="taken" style="display:grid; gap:12px;"></div>
          <p id="takenMsg" class="smallMuted" style="margin-top:10px;"></p>
        </div>
      </div>
    </div>

  </section>
</main>

<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHdr">
      <div class="modalTitle" id="modalTitle">Player</div>
      <button class="xBtn" id="modalClose" type="button">Close</button>
    </div>
    <div class="modalBody">
      <div id="modalTags" class="smallMuted" style="margin-bottom:10px;"></div>
      <div id="modalKV"></div>
    </div>
  </div>
</div>

<script src="./data.js"></script>
<script>
  const TOTAL_ROUNDS = 12;
  let slugToColor = new Map();

  // Fixed 3-column schema (5 fields per column)
  const DETAIL_SCHEMA = [
    // Column 1
    [
      ["Travel", "Travel"],
      ["TravelTeam", "Travel Team"],
      ["TravelLevel", "Travel Level"],
      ["Pitcher", "Pitcher"],
      ["CoachKid", "Coach Kid"]
    ],
    // Column 2
    [
      ["Spring2025HeadCoach", "2025 Spring Head Coach"],
      ["SpringPitching", "Spring Pitching"],
      ["SpringHitting", "Spring Hitting"],
      ["SpringThrowing", "Spring Throwing"],
      ["SpringFielding", "Spring Fielding"]
    ],
    // Column 3
    [
      ["School", "School"],
      ["CoachRequest", "Coach Request"],
      ["FriendRequest", "Friend Request"],
      ["OtherSpringSport", "Other Spring Sport"],
      ["Conflict", "Conflict"]
    ]
  ];

  function safe(v){ return String(v ?? "").trim(); }
  function norm(v){ return safe(v).toLowerCase(); }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function fetchCsv(url){
    if (!url) throw new Error("Missing CSV URL in data.js (check window.SHEET.*)");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache:"no-store" });
    if (!res.ok) throw new Error("Failed to fetch CSV: " + res.status);
    return await res.text();
  }

  function parseCsv(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;
    for (let i=0; i<text.length; i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if (!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }
      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }
      cur += ch;
    }
    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g,""));
    return rows.map(r => {
      const o = {};
      headers.forEach((h, idx) => o[h] = safe(r[idx]));
      return o;
    }).filter(o => Object.values(o).some(v => safe(v) !== ""));
  }

  function getRosterName(r){
    return safe(r.PlayerName || r.Name);
  }

  function buildPlayerMap(pool){
    const m = new Map();
    for (const p of pool){
      const name = safe(p.Name);
      if (!name) continue;
      m.set(norm(name), p);
    }
    return m;
  }

  function assignForfeitsForTeam(baseRounds){
    const used = new Set();
    const out = [];
    const sorted = baseRounds.slice().sort((a,b)=>a-b);
    for (const base of sorted){
      let r = base;
      while (used.has(r)) r++;
      used.add(r);
      out.push(r);
    }
    return out;
  }

  function computeForfeits(teams, roster, playerMap){
    const nameToSlug = new Map();
    for (const r of roster){
      const nm = norm(getRosterName(r));
      const slug = safe(r.TeamSlug);
      if (nm && slug) nameToSlug.set(nm, slug);
    }

    const baseByTeam = new Map();
    for (const [nm, p] of playerMap.entries()){
      if (norm(p.CoachKid) !== "y") continue;
      const slug = nameToSlug.get(nm);
      if (!slug) continue;
      const lvl = norm(p.TravelLevel);
      if (lvl === "a"){
        if (!baseByTeam.has(slug)) baseByTeam.set(slug, []);
        baseByTeam.get(slug).push(1);
      } else if (lvl === "b"){
        if (!baseByTeam.has(slug)) baseByTeam.set(slug, []);
        baseByTeam.get(slug).push(2);
      }
    }

    const forfeits = new Map();
    for (const t of teams){
      const slug = safe(t.TeamSlug);
      if (!slug) continue;
      const assigned = assignForfeitsForTeam(baseByTeam.get(slug) || []);
      forfeits.set(slug, new Set(assigned));
    }
    return forfeits;
  }

  function buildPickSequenceSnake(teams, forfeits){
    const order = teams
      .map(t => ({ slug: safe(t.TeamSlug), name: safe(t.TeamName) || safe(t.TeamSlug) }))
      .filter(t => t.slug);

    const n = order.length;
    const seq = [];
    for (let round = 1; round <= TOTAL_ROUNDS; round++){
      const isOdd = (round % 2) === 1;
      for (let pos = 0; pos < n; pos++){
        const idx = isOdd ? pos : (n - 1 - pos);
        const team = order[idx];
        const fset = forfeits.get(team.slug) || new Set();
        if (fset.has(round)) continue;
        seq.push({ round, teamSlug: team.slug, teamName: team.name });
      }
    }
    return seq;
  }

  function applyFilters(players){
    const q = norm(document.getElementById("q").value);
    const travel = norm(document.getElementById("travelFilter").value);
    const level = norm(document.getElementById("levelFilter").value);
    const pitcher = norm(document.getElementById("pitcherFilter").value);
    const school = norm(document.getElementById("schoolFilter").value);

    const sp = norm(document.getElementById("springPitchingFilter").value);
    const sh = norm(document.getElementById("springHittingFilter").value);
    const st = norm(document.getElementById("springThrowingFilter").value);
    const sf = norm(document.getElementById("springFieldingFilter").value);

    return players.filter(p => {
      const name = norm(p.Name);
      if (q && !name.includes(q)) return false;

      const tr = norm(p.Travel);
      if (travel === "y" && tr !== "y") return false;
      if (travel === "n" && tr === "y") return false;

      const lv = norm(p.TravelLevel);
      if (level === "none") {
        if (lv) return false;
      } else if (level && lv !== level) {
        return false;
      }

      const pi = norm(p.Pitcher);
      if (pitcher === "y" && pi !== "y") return false;
      if (pitcher === "n" && pi === "y") return false;

      const sc = norm(p.School);
      if (school && sc !== school) return false;

      if (sp && norm(p.SpringPitching) !== sp) return false;
      if (sh && norm(p.SpringHitting)  !== sh) return false;
      if (st && norm(p.SpringThrowing) !== st) return false;
      if (sf && norm(p.SpringFielding) !== sf) return false;

      return true;
    });
  }

  function getValOrNA(p, key){
    const v = safe(p[key]);
    return v ? v : "n/a";
  }

  function renderDetailsThreeCols(p){
    const renderCol = (pairs) => `
      <div class="kvCol3">
        ${pairs.map(([key, label]) => {
          const v = getValOrNA(p, key);
          const isNA = (v === "n/a");
          return `
            <div class="k">${escapeHtml(label)}</div>
            <div class="v ${isNA ? "na" : ""}">${escapeHtml(v)}</div>
          `;
        }).join("")}
      </div>
    `;

    return `
      <div class="kv3">
        ${renderCol(DETAIL_SCHEMA[0])}
        ${renderCol(DETAIL_SCHEMA[1])}
        ${renderCol(DETAIL_SCHEMA[2])}
      </div>
    `;
  }

  // Modal
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalTags = document.getElementById("modalTags");
  const modalKV = document.getElementById("modalKV");
  const modalClose = document.getElementById("modalClose");

  function openModalForPlayer(p){
    modalTitle.textContent = safe(p.Name);

    const tags = [];
    if (norm(p.Pitcher) === "y") tags.push("Pitcher");
    if (norm(p.Travel) === "y") tags.push("Travel");
    if (safe(p.TravelLevel)) tags.push("Level " + safe(p.TravelLevel).toUpperCase());
    if (safe(p.TravelTeam)) tags.push(safe(p.TravelTeam));
    if (safe(p.School)) tags.push(safe(p.School));
    if (norm(p.CoachKid) === "y") tags.push("Coach kid");
    modalTags.textContent = tags.join(" • ");

    modalKV.innerHTML = renderDetailsThreeCols(p);

    modalBackdrop.classList.add("open");
    modalBackdrop.setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    modalBackdrop.classList.remove("open");
    modalBackdrop.setAttribute("aria-hidden", "true");
  }
  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  function renderAvailable(list){
    const el = document.getElementById("available");
    const msg = document.getElementById("availMsg");
    el.innerHTML = "";

    if (!list.length){
      msg.textContent = "No available players match the current filters.";
      return;
    }
    msg.textContent = "";

    for (const p of list){
      const name = safe(p.Name);
      const tags = [];

      if (norm(p.Pitcher) === "y") tags.push(`<span class="pill good">P</span>`);
      if (norm(p.Travel) === "y") {
        const lvl = safe(p.TravelLevel).toUpperCase();
        tags.push(`<span class="pill ${lvl === "A" ? "warn" : ""}">Travel${lvl ? " " + lvl : ""}</span>`);
      }

      const hoverKV = renderDetailsThreeCols(p);

      const div = document.createElement("div");
      div.className = "card playerRow";
      div.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div class="tightRow">
            <div class="tightLeft">
              <div class="tightName">${escapeHtml(name)}</div>
              <div class="tightMeta">${tags.join("")}</div>
            </div>
            <div class="smallMuted">Tap/click for details</div>
          </div>

          <div class="hoverCard" aria-hidden="true">
            <div style="font-weight:1000; margin-bottom:10px;">${escapeHtml(name)}</div>
            ${hoverKV}
          </div>
        </div>
      `;
      div.addEventListener("click", () => openModalForPlayer(p));
      el.appendChild(div);
    }
  }

  function renderTakenByTeam(rosterRows, teamsRows, playerMap){
    const onlySlug = safe(document.getElementById("takenTeamFilter")?.value);

    const el = document.getElementById("taken");
    const msg = document.getElementById("takenMsg");
    el.innerHTML = "";

    const slugToName = new Map();
    for (const t of teamsRows){
      const slug = safe(t.TeamSlug);
      const nm = safe(t.TeamName);
      if (slug) slugToName.set(slug, nm || slug);
    }

    const taken = rosterRows
      .map(r => ({
        slug: safe(r.TeamSlug),
        name: getRosterName(r),
        slot: safe(r.PlayerID)
      }))
      .filter(x => x.slug && x.name)
      .filter(x => !onlySlug || x.slug === onlySlug);

    if (!taken.length){
      msg.textContent = onlySlug ? "No players taken yet for that team." : "No picks recorded yet (Roster tab still empty).";
      return;
    }
    msg.textContent = "";

    const byTeam = new Map();
    for (const x of taken){
      if (!byTeam.has(x.slug)) byTeam.set(x.slug, []);
      byTeam.get(x.slug).push(x);
    }

    const teams = [...byTeam.keys()].map(slug => ({
      slug,
      name: slugToName.get(slug) || slug
    })).sort((a,b) => a.name.localeCompare(b.name));

    for (const t of teams){
      const picks = byTeam.get(t.slug) || [];
      picks.sort((a,b) => a.slot.localeCompare(b.slot));

      let aCount = 0;
      for (const p of picks){
        const dp = playerMap.get(norm(p.name));
        if (dp && norm(dp.TravelLevel) === "a") aCount++;
      }
      const aBadge =
        aCount > 2
          ? `<span class="pill bad">A: ${aCount}/2</span>`
          : (aCount === 2 ? `<span class="pill warn">A: ${aCount}/2</span>` : `<span class="pill good">A: ${aCount}/2</span>`);

      const section = document.createElement("div");
      section.className = "card";
      section.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:10px;">
            <div style="font-weight:1000;">${escapeHtml(t.name)}</div>
            ${aBadge}
          </div>
          <div style="display:grid; gap:6px;">
            ${picks.map(p => `
              <div class="smallMuted">
                <strong>${escapeHtml(p.slot || "—")}:</strong> ${escapeHtml(p.name)}
              </div>
            `).join("")}
          </div>
        </div>
      `;
      el.appendChild(section);
    }
  }

  function renderForfeitsLine(teams, forfeits){
    const parts = [];
    for (const t of teams){
      const slug = safe(t.TeamSlug);
      const name = safe(t.TeamName) || slug;
      const rounds = [...(forfeits.get(slug) || new Set())].sort((a,b)=>a-b);
      if (rounds.length) parts.push(`${name}: forfeits R${rounds.join(", R")}`);
    }
    document.getElementById("forfeitLine").textContent =
      parts.length ? ("Forfeits: " + parts.join(" • ")) : "Forfeits: none";
  }

  function computeClockFromSequence(pickSeq, picksMade){
    document.getElementById("picksMade").textContent = String(Math.max(0, picksMade));
    document.getElementById("totalRounds").textContent = String(TOTAL_ROUNDS);

    const cur = pickSeq[picksMade];
    const nxt = pickSeq[picksMade + 1];

    const onEl = document.getElementById("onClock");
    onEl.textContent = cur?.teamName || "—";

    if (cur?.teamSlug) {
      const c = slugToColor.get(cur.teamSlug);
      onEl.style.color = c ? c : "";
    } else {
      onEl.style.color = "";
    }

    document.getElementById("upNext").textContent = nxt?.teamName || "—";
    document.getElementById("round").textContent = cur ? String(cur.round) : "—";

    const pickPill = document.getElementById("pickPill");
    pickPill.textContent = "Pick " + (picksMade + 1);
    pickPill.className = cur ? "pill" : "pill bad";
  }

  function computePicksMadeAutomatically(rosterRows, playerMap){
    const rosteredNames = rosterRows.map(getRosterName).filter(Boolean);
    let coachKidsOnRoster = 0;
    for (const name of rosteredNames){
      const p = playerMap.get(norm(name));
      if (p && norm(p.CoachKid) === "y") coachKidsOnRoster++;
    }
    return Math.max(0, rosteredNames.length - coachKidsOnRoster);
  }

  function populateSchoolOptions(pool){
    const sel = document.getElementById("schoolFilter");

    const prev = sel.value;
    const schools = Array.from(new Set(
      pool.map(p => safe(p.School)).filter(Boolean)
    )).sort((a,b) => a.localeCompare(b));

    sel.innerHTML =
      `<option value="">All</option>` +
      schools.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

    if (schools.includes(prev)) sel.value = prev;
    else sel.value = "";
  }

  function populateTakenTeamOptions(teams){
    const sel = document.getElementById("takenTeamFilter");
    const prev = sel.value;

    const opts = teams
      .map(t => ({ slug: safe(t.TeamSlug), name: safe(t.TeamName) }))
      .filter(t => t.slug && t.name)
      .sort((a,b) => a.name.localeCompare(b.name));

    sel.innerHTML =
      `<option value="">All teams</option>` +
      opts.map(t => `<option value="${escapeHtml(t.slug)}">${escapeHtml(t.name)}</option>`).join("");

    if (opts.some(t => t.slug === prev)) sel.value = prev;
    else sel.value = "";
  }

  function clearFilters(){
    document.getElementById("pitcherFilter").value = "";
    document.getElementById("travelFilter").value = "";
    document.getElementById("levelFilter").value = "";
    document.getElementById("schoolFilter").value = "";
    document.getElementById("takenTeamFilter").value = "";
    document.getElementById("springPitchingFilter").value = "";
    document.getElementById("springHittingFilter").value = "";
    document.getElementById("springThrowingFilter").value = "";
    document.getElementById("springFieldingFilter").value = "";
    document.getElementById("q").value = "";
  }

  let autoTimer = null;

  async function loadAndRender(){
    const meta = document.getElementById("meta");
    meta.textContent = "Loading…";

    const [teamsCsv, rosterCsv, poolCsv] = await Promise.all([
      fetchCsv(window.SHEET?.TEAMS_CSV_URL),
      fetchCsv(window.SHEET?.ROSTER_CSV_URL),
      fetchCsv(window.SHEET?.DRAFTPOOL_CSV_URL),
    ]);

    const teams = parseCsv(teamsCsv);
    const roster = parseCsv(rosterCsv);
    const poolRaw = parseCsv(poolCsv);

    slugToColor = new Map(
      teams
        .map(t => [safe(t.TeamSlug), safe(t.TeamColor)])
        .filter(([slug, color]) => slug && color)
    );

    const pool = poolRaw.map(p => {
      const out = {};
      for (const k of Object.keys(p)) out[k] = safe(p[k]);
      return out;
    });

    populateSchoolOptions(pool);
    populateTakenTeamOptions(teams);

    const playerMap = buildPlayerMap(pool);

    const takenNames = new Set(
      roster.map(getRosterName).filter(Boolean).map(n => norm(n))
    );

    const availableAll = pool.filter(p => p.Name && !takenNames.has(norm(p.Name)));
    const availableFiltered = applyFilters(availableAll);
    availableFiltered.sort((a,b) => safe(a.Name).localeCompare(safe(b.Name)));

    const forfeits = computeForfeits(teams, roster, playerMap);
    renderForfeitsLine(teams, forfeits);

    const pickSeq = buildPickSequenceSnake(teams, forfeits);

    const picksMade = computePicksMadeAutomatically(roster, playerMap);
    computeClockFromSequence(pickSeq, picksMade);

    renderAvailable(availableFiltered);
    renderTakenByTeam(roster, teams, playerMap);

    meta.textContent =
      `Available: ${availableAll.length} • Showing: ${availableFiltered.length} • Taken: ${takenNames.size} • Updated: ${new Date().toLocaleTimeString()}`;
  }

  function init(){
    document.getElementById("refreshBtn")
      .addEventListener("click", () => loadAndRender().catch(err => alert(err.message)));

    document.getElementById("clearBtn")
      .addEventListener("click", () => {
        clearFilters();
        loadAndRender().catch(()=>{});
      });

    [
      "q",
      "pitcherFilter","travelFilter","levelFilter","schoolFilter","takenTeamFilter",
      "springPitchingFilter","springHittingFilter","springThrowingFilter","springFieldingFilter"
    ].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", () => loadAndRender().catch(()=>{}));
      el.addEventListener("change", () => loadAndRender().catch(()=>{}));
    });

    autoTimer = setInterval(() => loadAndRender().catch(()=>{}), 8000);

    loadAndRender().catch(err => {
      console.error(err);
      alert("Draft page error: " + err.message);
    });
  }

  init();
</script>

<script src="./nav.js"></script>
</body>
</html>
