<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draft • WBL 3rd Grade 2026</title>

  <link rel="stylesheet" href="./styles.css?v=wbl2026-draft-13" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    .draftPage .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      font-size:12px; font-weight:800;
      background: rgba(255,255,255,.8);
      white-space:nowrap;
    }
    .draftPage .pill.good{ border-color: rgba(0,150,80,.35); }
    .draftPage .pill.warn{ border-color: rgba(200,120,0,.45); }
    .draftPage .pill.bad { border-color: rgba(190,40,40,.45); }

    .draftPage .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .draftPage .grid2{ grid-template-columns: 1fr; } }

    .draftPage .smallMuted{ font-size:12px; color: rgba(0,0,0,.55); font-weight:700; }

    /* -----------------------------
       ON THE CLOCK (STYLING + WASH)
       ----------------------------- */
    .draftPage .clockCard{
      position:relative;
      overflow:hidden;
    }
    .draftPage .clockCard::before{
      content:"";
      position:absolute;
      inset:0;
      background: var(--teamWash, transparent);
      opacity: .14;
      pointer-events:none;
    }
    .draftPage .clockCard .cardBody{ position:relative; }

    .draftPage .clockLine{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:baseline; justify-content:center; text-align:center;
    }
    .draftPage .clockLine > div{ width:100%; }

    .draftPage .clockHeadline{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      align-items:baseline;
      gap:8px;
      margin-bottom:6px;
    }
    .draftPage .clockHeadline .label{
      font-size:28px;
      font-weight:1000;
      color: rgba(0,0,0,.85);
    }
    .draftPage .clockHeadline .team{
      font-size:28px;
      font-weight:1000;
    }
    @media (max-width: 520px){
      .draftPage .clockHeadline .label,
      .draftPage .clockHeadline .team{ font-size:22px; }
    }

    /* -----------------------------
       ESPN-STYLE LAST 5 PICKS TICKER
       ----------------------------- */
    .draftPage .tickerWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
      justify-items:stretch; /* was center; stretch prevents “shift right” */
    }
    .draftPage .ticker{
      width:min(820px, 100%);
      margin: 0 auto; /* ensure centered */
      border:1px solid rgba(0,0,0,.10);
      border-radius:14px;
      background: rgba(255,255,255,.75);
      padding:10px 10px;
    }
    .draftPage .tickerHdr{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-bottom:6px;
    }
    .draftPage .tickerTitle{
      font-weight:1000;
      font-size:12px;
      color: rgba(0,0,0,.70);
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    .draftPage .tickerSub{
      font-size:12px;
      font-weight:800;
      color: rgba(0,0,0,.55);
    }

    .draftPage .tickerMarquee{
      width:100%;
      overflow:hidden;
      border-radius:12px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.08);
    }

    .draftPage .tickerTrack{
      display:flex;               /* was inline-flex */
      align-items:center;
      gap:22px;
      padding:10px 12px;
      white-space:nowrap;
      width:max-content;
      will-change: transform;
      animation: tickerScroll var(--tickerSpeed, 18s) linear infinite;
    }

    @media (hover:hover) and (pointer:fine){
      .draftPage .tickerMarquee:hover .tickerTrack{
        animation-play-state: paused;
      }
    }

    .draftPage .tickItem{
      display:inline-flex;
      align-items:baseline;
      gap:8px;
      font-size:12px;
      font-weight:900;
    }
    .draftPage .tickSlot{
      color:#1e40af;
      font-weight:1000;
    }
    .draftPage .tickText{
      color: rgba(0,0,0,.88);
      font-weight:900;
    }
    .draftPage .tickSep{
      color: rgba(0,0,0,.30);
      font-weight:1000;
    }

    @keyframes tickerScroll{
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }

    /* Mobile: swipe instead of animation */
    @media (max-width: 520px){
      .draftPage .tickerMarquee{
        overflow-x:auto;
        -webkit-overflow-scrolling: touch;
      }
      .draftPage .tickerTrack{
        animation: none;
      }
    }

    /* -----------------------------
       PLAYER CARDS / DETAILS
       ----------------------------- */
    .draftPage .tightRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .draftPage .tightLeft{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .draftPage .tightName{ font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .draftPage .tightMeta{ display:flex; flex-wrap:wrap; gap:6px; }

    .draftPage .playerRow{ position:relative; cursor:pointer; }
    .draftPage .hoverCard{
      display:none;
      position:absolute;
      left:0; top:100%;
      margin-top:10px;
      width:min(860px, 92vw);
      background:#fff;
      border:1px solid rgba(0,0,0,.14);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 14px 32px rgba(0,0,0,.14);
      z-index: 50;
    }
    @media (hover:hover) and (pointer:fine){
      .draftPage .playerRow:hover .hoverCard{ display:block; }
    }

    .draftPage .k{ color:#1e40af; font-size:12px; font-weight:900; }
    .draftPage .v{ color: rgba(0,0,0,.88); font-size:12px; }
    .draftPage .na{ color: rgba(0,0,0,.45); font-style:italic; }

    .draftPage .kv3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px 18px;
    }
    @media (max-width: 980px){ .draftPage .kv3{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 640px){ .draftPage .kv3{ grid-template-columns: 1fr; } }

    .draftPage .kvCol3{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap: 8px 12px;
    }
    @media (max-width: 520px){ .draftPage .kvCol3{ grid-template-columns: 140px 1fr; } }

    /* -----------------------------
       MODAL
       ----------------------------- */
    .draftPage .modalBackdrop{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      z-index: 1000;
      padding: 18px;
    }
    .draftPage .modalBackdrop.open{ display:flex; align-items:flex-start; justify-content:center; }
    .draftPage .modalCard{
      width:min(920px, 96vw);
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.16);
      box-shadow: 0 18px 50px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .draftPage .modalHdr{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(0,0,0,.10);
    }
    .draftPage .modalTitle{ font-weight:1000; }
    .draftPage .modalBody{ padding:14px; }
    .draftPage .xBtn{
      border:1px solid rgba(0,0,0,.14);
      background: rgba(255,255,255,.9);
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }

    /* -----------------------------
       FILTER BOX (5 + 4 + actions row)
       ----------------------------- */
    .draftPage .filtersCard .cardBody{ padding:12px; }

    .draftPage .filtersShell{
      position:relative;
      border-radius:14px;
      padding:10px;
      background:
        linear-gradient(180deg, rgba(30,64,175,.06), rgba(30,64,175,0) 55%),
        repeating-linear-gradient(135deg,
          rgba(30,64,175,.045) 0px,
          rgba(30,64,175,.045) 10px,
          rgba(30,64,175,0) 10px,
          rgba(30,64,175,0) 28px
        );
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.7);
      overflow:hidden;
    }
    .draftPage .filtersShell::after{
      content:"DRAFT ROOM";
      position:absolute;
      right:14px;
      top:10px;
      font-weight:1000;
      letter-spacing:.18em;
      font-size:12px;
      color: rgba(30,64,175,.22);
      transform: rotate(-6deg);
      pointer-events:none;
      user-select:none;
      text-transform: uppercase;
    }

    .draftPage .filtersWrap{ display:grid; gap:10px; }
    .draftPage .filtersGrid5{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      align-items:end;
    }
    .draftPage .filtersGrid4{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      align-items:end;
    }
    @media (max-width: 980px){
      .draftPage .filtersGrid5{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .draftPage .filtersGrid4{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px){
      .draftPage .filtersGrid5{ grid-template-columns: 1fr 1fr; }
      .draftPage .filtersGrid4{ grid-template-columns: 1fr 1fr; }
    }

    .draftPage .field{ display:flex; flex-direction:column; gap:5px; min-width:0; }
    .draftPage .field .lbl{ font-size:12px; font-weight:900; color: rgba(0,0,0,.55); }

    .draftPage input[type="text"], .draftPage select{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      font-size:14px;
    }

    .draftPage .btnSecondary{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.92);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }

    .draftPage .actionsRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      margin-top:2px;
    }
    @media (max-width: 720px){
      .draftPage .actionsRow{ grid-template-columns: 1fr; }
    }
    .draftPage .btnGroup{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      align-items:center;
    }

    .draftPage #meta{ margin-top:8px !important; }

    /* -----------------------------
       Taken toggle tabs + Draft Order board
       ----------------------------- */
    .draftPage .takenHdrRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin:0 0 10px 0;
    }
    .draftPage .pillTabs{
      display:flex;
      gap:6px;
      background: rgba(0,0,0,.06);
      padding:5px;
      border-radius:999px;
      align-items:center;
    }
    .draftPage .pillTab{
      appearance:none;
      border:0;
      background: transparent;
      padding:7px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
      color: rgba(0,0,0,.75);
    }
    .draftPage .pillTab.active{
      background:#fff;
      box-shadow: 0 1px 2px rgba(0,0,0,.10);
      color: rgba(0,0,0,.92);
    }

    .draftPage .boardRoundTitle{
      font-weight:1000;
      margin: 2px 0 10px 0;
    }
    .draftPage .boardRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      background:#fff;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    .draftPage .boardLeft{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .draftPage .boardPick{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      color: rgba(0,0,0,.65);
      min-width: 88px;
    }
    .draftPage .boardTeam{
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 210px;
    }
    .draftPage .boardPlayer{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color: rgba(0,0,0,.85);
      font-weight:900;
      max-width: 320px;
      text-align:right;
    }
    .draftPage .boardPlayer.muted{
      color: rgba(0,0,0,.40);
      font-weight:900;
    }
    .draftPage .boardRow.forfeit{
      background: rgba(0,0,0,.03);
    }

    /* Small coachkid marker */
    .draftPage .fMark{
      font-size:11px;
      font-weight:1000;
      color: rgba(0,0,0,.55);
      margin-left:6px;
    }
  </style>
</head>

<body class="watermarkPage draftPage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="siteNav">
      <span></span><span></span><span></span>
    </button>
    <div class="navOverlay" aria-hidden="true"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Draft Board</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">

    <div class="card filtersCard">
      <div class="cardBody">
        <div class="filtersShell">
          <div class="filtersWrap">

            <div class="filtersGrid5">
              <div class="field">
                <div class="lbl">Pitcher</div>
                <select id="pitcherFilter">
                  <option value="">All</option>
                  <option value="y">Pitcher (Y)</option>
                  <option value="n">Not marked</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Travel</div>
                <select id="travelFilter">
                  <option value="">All</option>
                  <option value="y">Travel (Y)</option>
                  <option value="n">Non-travel (N)</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Travel Level</div>
                <select id="levelFilter">
                  <option value="">All</option>
                  <option value="a">A</option>
                  <option value="b">B</option>
                  <option value="c">C</option>
                  <option value="none">None</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">School</div>
                <select id="schoolFilter">
                  <option value="">All</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Taken team</div>
                <select id="takenTeamFilter">
                  <option value="">All teams</option>
                </select>
              </div>
            </div>

            <div class="filtersGrid4">
              <div class="field">
                <div class="lbl">Spring Pitching</div>
                <select id="springPitchingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Spring Hitting</div>
                <select id="springHittingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Spring Throwing</div>
                <select id="springThrowingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>

              <div class="field">
                <div class="lbl">Spring Fielding</div>
                <select id="springFieldingFilter">
                  <option value="">All</option>
                  <option value="Developing">Developing</option>
                  <option value="Age Appropriate">Age Appropriate</option>
                  <option value="Above Age Level">Above Age Level</option>
                </select>
              </div>
            </div>

            <div class="actionsRow">
              <div class="field" style="gap:0;">
                <input id="q" type="text" placeholder="Search player name…" />
              </div>

              <div class="btnGroup">
                <button id="clearBtn" class="btnSecondary" type="button">Clear filters</button>
                <button id="refreshBtn" class="btnSecondary" type="button">Refresh</button>
              </div>
            </div>

          </div>
        </div>

        <div class="smallMuted" id="meta" style="margin-top:10px;"></div>
      </div>
    </div>

    <div class="card clockCard" style="margin-top:14px;">
      <div class="cardBody">
        <div class="clockLine">
          <div>

            <div class="clockHeadline">
              <span class="label">On the clock:</span>
              <span class="team" id="onClock">—</span>
              <span class="pill" id="pickPill">Pick —</span>
            </div>

            <div class="smallMuted">
              Up next: <span id="upNext">—</span>
              • Round: <span id="round">—</span> / <span id="totalRounds">12</span>
              • Picks made: <span id="picksMade">0</span>
            </div>

            <!-- removed: forfeit line in header -->

            <div class="tickerWrap">
              <div class="ticker">
                <div class="tickerHdr">
                  <div class="tickerTitle">Last 5 picks</div>
                  <div class="tickerSub" id="lastPicksMeta">—</div>
                </div>

                <div class="tickerMarquee" id="lastPicksMarquee">
                  <div class="tickerTrack" id="lastPicksTrack"></div>
                </div>
              </div>
            </div>

          </div>
          <div class="smallMuted">Auto-refresh: <span id="autoRefreshState">ON</span></div>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:14px;">
      <div class="card">
        <div class="cardBody">
          <h2 style="margin:0 0 10px 0;">Available</h2>
          <div id="available" style="display:grid; gap:10px;"></div>
          <p id="availMsg" class="smallMuted" style="margin-top:10px;"></p>
        </div>
      </div>

      <div class="card">
        <div class="cardBody">
          <div class="takenHdrRow">
            <h2 style="margin:0;">Taken</h2>
            <div class="pillTabs" id="takenViewTabs" aria-label="Taken view toggle">
              <button id="viewTakenBtn" class="pillTab active" type="button" aria-pressed="true">By team</button>
              <button id="viewBoardBtn" class="pillTab" type="button" aria-pressed="false">Draft order</button>
            </div>
          </div>

          <div id="taken" style="display:grid; gap:12px;"></div>
          <div id="draftBoard" style="display:none; gap:12px;"></div>

          <p id="takenMsg" class="smallMuted" style="margin-top:10px;"></p>
        </div>
      </div>
    </div>

  </section>
</main>

<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHdr">
      <div class="modalTitle" id="modalTitle">Player</div>
      <button class="xBtn" id="modalClose" type="button">Close</button>
    </div>
    <div class="modalBody">
      <div id="modalTags" class="smallMuted" style="margin-bottom:10px;"></div>
      <div id="modalKV"></div>
    </div>
  </div>
</div>

<script src="./data.js"></script>
<script>
  const TOTAL_ROUNDS = 12;
  let slugToColor = new Map();
  let TAKEN_VIEW = "team"; // "team" | "board"

  // CoachKid forfeits:
  // A => Round 1
  // B => Round 2
  // Otherwise => Round 8
  // Collisions push forward (e.g., two non-A/B => 8 and 9)
  const COACHKID_DEFAULT_ROUND = 8;

  const DETAIL_SCHEMA = [
    [
      ["Travel", "Travel"],
      ["TravelTeam", "Travel Team"],
      ["TravelLevel", "Travel Level"],
      ["Pitcher", "Pitcher"],
      ["CoachKid", "Coach Kid"]
    ],
    [
      ["Spring2025HeadCoach", "2025 Spring Head Coach"],
      ["SpringPitching", "Spring Pitching"],
      ["SpringHitting", "Spring Hitting"],
      ["SpringThrowing", "Spring Throwing"],
      ["SpringFielding", "Spring Fielding"]
    ],
    [
      ["School", "School"],
      ["CoachRequest", "Coach Request"],
      ["FriendRequest", "Friend Request"],
      ["OtherSpringSport", "Other Spring Sport"],
      ["Conflict", "Conflict"]
    ]
  ];

  function safe(v){ return String(v ?? "").trim(); }
  function norm(v){ return safe(v).toLowerCase(); }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function colorToRgba(color, alpha){
    const c = safe(color);
    const a = Math.max(0, Math.min(1, Number(alpha)));
    if (!c) return `rgba(0,0,0,${a})`;

    const hex = c.startsWith("#") ? c.slice(1) : "";
    if (hex && (hex.length === 3 || hex.length === 6)){
      const h = hex.length === 3 ? hex.split("").map(ch => ch+ch).join("") : hex;
      const r = parseInt(h.slice(0,2), 16);
      const g = parseInt(h.slice(2,4), 16);
      const b = parseInt(h.slice(4,6), 16);
      if ([r,g,b].every(n => Number.isFinite(n))) return `rgba(${r},${g},${b},${a})`;
    }

    const m = c.match(/^rgba?\(([^)]+)\)$/i);
    if (m){
      const parts = m[1].split(",").map(x => x.trim());
      const r = Number(parts[0]);
      const g = Number(parts[1]);
      const b = Number(parts[2]);
      if ([r,g,b].every(n => Number.isFinite(n))) return `rgba(${r},${g},${b},${a})`;
    }

    return `rgba(0,0,0,${a})`;
  }

  async function fetchCsv(url){
    if (!url) throw new Error("Missing CSV URL in data.js (check window.SHEET.*)");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache:"no-store" });
    if (!res.ok) throw new Error("Failed to fetch CSV: " + res.status);
    return await res.text();
  }

  function parseCsv(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;
    for (let i=0; i<text.length; i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if (!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }
      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }
      cur += ch;
    }
    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g,""));
    return rows.map(r => {
      const o = {};
      headers.forEach((h, idx) => o[h] = safe(r[idx]));
      return o;
    }).filter(o => Object.values(o).some(v => safe(v) !== ""));
  }

  function getRosterName(r){
    return safe(r.PlayerName || r.Name);
  }

  function buildPlayerMap(pool){
    const m = new Map();
    for (const p of pool){
      const name = safe(p.Name);
      if (!name) continue;
      m.set(norm(name), p);
    }
    return m;
  }

  function assignForfeitsForTeam(baseRounds){
    const used = new Set();
    const out = [];
    const sorted = baseRounds.slice().sort((a,b)=>a-b);
    for (const base of sorted){
      let r = base;
      while (used.has(r)) r++;
      used.add(r);
      out.push(r);
    }
    return out;
  }

  function computeForfeits(teams, roster, playerMap){
    // map rostered player name -> TeamSlug
    const nameToSlug = new Map();
    for (const r of roster){
      const nm = norm(getRosterName(r));
      const slug = safe(r.TeamSlug);
      if (nm && slug) nameToSlug.set(nm, slug);
    }

    // base forfeits by team based on DraftPool coach kids that are on that team's roster
    const baseByTeam = new Map();
    for (const [nm, p] of playerMap.entries()){
      if (norm(p.CoachKid) !== "y") continue;
      const slug = nameToSlug.get(nm);
      if (!slug) continue;

      const lvl = norm(p.TravelLevel);
      let base = COACHKID_DEFAULT_ROUND;
      if (lvl === "a") base = 1;
      else if (lvl === "b") base = 2;

      if (!baseByTeam.has(slug)) baseByTeam.set(slug, []);
      baseByTeam.get(slug).push(base);
    }

    const forfeits = new Map();
    for (const t of teams){
      const slug = safe(t.TeamSlug);
      if (!slug) continue;
      const assigned = assignForfeitsForTeam(baseByTeam.get(slug) || []);
      forfeits.set(slug, new Set(assigned));
    }
    return forfeits;
  }

  // Pick sequence used for ON-THE-CLOCK: excludes forfeited picks
  function buildPickSequenceSnake(teams, forfeits){
    const order = teams
      .map(t => ({ slug: safe(t.TeamSlug), name: safe(t.TeamName) || safe(t.TeamSlug) }))
      .filter(t => t.slug);

    const n = order.length;
    const seq = [];
    for (let round = 1; round <= TOTAL_ROUNDS; round++){
      const isOdd = (round % 2) === 1;
      for (let pos = 0; pos < n; pos++){
        const idx = isOdd ? pos : (n - 1 - pos);
        const team = order[idx];
        const fset = forfeits.get(team.slug) || new Set();
        if (fset.has(round)) continue; // forfeited slot removed from on-clock sequence
        seq.push({ round, posInRound: pos+1, teamSlug: team.slug, teamName: team.name });
      }
    }
    return seq;
  }

  // Full board slots for Draft Order view: includes forfeits
  function buildBoardSlotsSnake(teams, forfeits){
    const order = teams
      .map(t => ({ slug: safe(t.TeamSlug), name: safe(t.TeamName) || safe(t.TeamSlug) }))
      .filter(t => t.slug);

    const n = order.length;
    const slots = [];
    for (let round = 1; round <= TOTAL_ROUNDS; round++){
      const isOdd = (round % 2) === 1;
      for (let pos = 0; pos < n; pos++){
        const idx = isOdd ? pos : (n - 1 - pos);
        const team = order[idx];
        const fset = forfeits.get(team.slug) || new Set();
        slots.push({
          round,
          posInRound: pos+1,
          teamSlug: team.slug,
          teamName: team.name,
          isForfeit: fset.has(round),
        });
      }
    }
    return slots;
  }

  function applyFilters(players){
    const q = norm(document.getElementById("q").value);
    const travel = norm(document.getElementById("travelFilter").value);
    const level = norm(document.getElementById("levelFilter").value);
    const pitcher = norm(document.getElementById("pitcherFilter").value);
    const school = norm(document.getElementById("schoolFilter").value);

    const sp = norm(document.getElementById("springPitchingFilter").value);
    const sh = norm(document.getElementById("springHittingFilter").value);
    const st = norm(document.getElementById("springThrowingFilter").value);
    const sf = norm(document.getElementById("springFieldingFilter").value);

    return players.filter(p => {
      const name = norm(p.Name);
      if (q && !name.includes(q)) return false;

      const tr = norm(p.Travel);
      if (travel === "y" && tr !== "y") return false;
      if (travel === "n" && tr === "y") return false;

      const lv = norm(p.TravelLevel);
      if (level === "none") {
        if (lv) return false;
      } else if (level && lv !== level) {
        return false;
      }

      const pi = norm(p.Pitcher);
      if (pitcher === "y" && pi !== "y") return false;
      if (pitcher === "n" && pi === "y") return false;

      const sc = norm(p.School);
      if (school && sc !== school) return false;

      if (sp && norm(p.SpringPitching) !== sp) return false;
      if (sh && norm(p.SpringHitting)  !== sh) return false;
      if (st && norm(p.SpringThrowing) !== st) return false;
      if (sf && norm(p.SpringFielding) !== sf) return false;

      return true;
    });
  }

  function getValOrNA(p, key){
    const v = safe(p[key]);
    return v ? v : "n/a";
  }

  function renderDetailsThreeCols(p){
    const renderCol = (pairs) => `
      <div class="kvCol3">
        ${pairs.map(([key, label]) => {
          const v = getValOrNA(p, key);
          const isNA = (v === "n/a");
          return `
            <div class="k">${escapeHtml(label)}</div>
            <div class="v ${isNA ? "na" : ""}">${escapeHtml(v)}</div>
          `;
        }).join("")}
      </div>
    `;
    return `
      <div class="kv3">
        ${renderCol(DETAIL_SCHEMA[0])}
        ${renderCol(DETAIL_SCHEMA[1])}
        ${renderCol(DETAIL_SCHEMA[2])}
      </div>
    `;
  }

  /* -----------------------------
     Team wash helpers
     ----------------------------- */
  function hexToRgb(hex){
    const h = safe(hex).replace("#","").trim();
    if (![3,6].includes(h.length)) return null;
    const full = h.length === 3 ? h.split("").map(c => c+c).join("") : h;
    const n = parseInt(full, 16);
    if (Number.isNaN(n)) return null;
    return { r: (n>>16)&255, g: (n>>8)&255, b: n&255 };
  }

  function setTeamWash(teamSlug){
    const card = document.querySelector(".clockCard");
    const hex = slugToColor.get(teamSlug) || "";
    const rgb = hexToRgb(hex);
    if (!card || !rgb) {
      if (card) card.style.setProperty("--teamWash", "transparent");
      return;
    }
    card.style.setProperty(
      "--teamWash",
      `linear-gradient(135deg, rgba(${rgb.r},${rgb.g},${rgb.b},0.55), rgba(${rgb.r},${rgb.g},${rgb.b},0.0) 65%)`
    );
  }

  /* -----------------------------
     ESPN-style last 5 picks ticker
     ----------------------------- */
  function renderLastPicks(rosterRows, teamsRows){
    const track = document.getElementById("lastPicksTrack");
    const meta = document.getElementById("lastPicksMeta");
    if (!track || !meta) return;

    const slugToName = new Map();
    for (const t of teamsRows){
      const slug = safe(t.TeamSlug);
      if (slug) slugToName.set(slug, safe(t.TeamName) || slug);
    }

    const taken = rosterRows
      .map(r => ({
        slot: safe(r.PlayerID),
        name: getRosterName(r),
        slug: safe(r.TeamSlug)
      }))
      .filter(x => x.slot && x.name && x.slug)
      .sort((a,b) => a.slot.localeCompare(b.slot)); // IDs are 2-digit (01..12), so string sort is OK

    const last = taken.slice(-5); // oldest -> newest among the last 5

    meta.textContent = taken.length ? `${taken.length} total` : "—";

    if (!last.length){
      track.innerHTML = `<span class="smallMuted" style="padding:10px 12px; display:inline-block;">No picks yet.</span>`;
      track.style.setProperty("--tickerSpeed", "0s");
      return;
    }

    const strip = last.map(x => {
      const teamName = slugToName.get(x.slug) || x.slug;
      return `
        <span class="tickItem">
          <span class="tickSlot">${escapeHtml(x.slot)}</span>
          <span class="tickText">${escapeHtml(x.name)} (${escapeHtml(teamName)})</span>
        </span>
      `;
    }).join(`<span class="tickSep">•</span>`);

    track.innerHTML = strip + `<span class="tickSep" style="margin:0 10px;">•</span>` + strip;

    const approxChars = strip.replace(/<[^>]*>/g,"").length;
    const seconds = Math.min(28, Math.max(14, Math.round(approxChars / 18)));
    track.style.setProperty("--tickerSpeed", `${seconds}s`);
  }

  /* -----------------------------
     Modal
     ----------------------------- */
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalTags = document.getElementById("modalTags");
  const modalKV = document.getElementById("modalKV");
  const modalClose = document.getElementById("modalClose");

  function openModalForPlayer(p){
    modalTitle.textContent = safe(p.Name);

    const tags = [];
    if (norm(p.Pitcher) === "y") tags.push("Pitcher");
    if (norm(p.Travel) === "y") tags.push("Travel");
    if (safe(p.TravelLevel)) tags.push("Level " + safe(p.TravelLevel).toUpperCase());
    if (safe(p.TravelTeam)) tags.push(safe(p.TravelTeam));
    if (safe(p.School)) tags.push(safe(p.School));
    if (norm(p.CoachKid) === "y") tags.push("Coach kid");
    modalTags.textContent = tags.join(" • ");

    modalKV.innerHTML = renderDetailsThreeCols(p);

    modalBackdrop.classList.add("open");
    modalBackdrop.setAttribute("aria-hidden", "false");
  }
  function closeModal(){
    modalBackdrop.classList.remove("open");
    modalBackdrop.setAttribute("aria-hidden", "true");
  }
  modalClose.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

  /* -----------------------------
     Taken view toggle
     ----------------------------- */
  function setTakenView(view){
    TAKEN_VIEW = view;
    const taken = document.getElementById("taken");
    const board = document.getElementById("draftBoard");
    const a = document.getElementById("viewTakenBtn");
    const b = document.getElementById("viewBoardBtn");
    if (!taken || !board || !a || !b) return;

    const isTeam = view === "team";
    taken.style.display = isTeam ? "grid" : "none";
    board.style.display = isTeam ? "none" : "grid";

    a.classList.toggle("active", isTeam);
    b.classList.toggle("active", !isTeam);
    a.setAttribute("aria-pressed", isTeam ? "true" : "false");
    b.setAttribute("aria-pressed", !isTeam ? "true" : "false");
  }

  /* -----------------------------
     Available + Taken rendering
     ----------------------------- */
  function renderAvailable(list){
    const el = document.getElementById("available");
    const msg = document.getElementById("availMsg");
    el.innerHTML = "";

    if (!list.length){
      msg.textContent = "No available players match the current filters.";
      return;
    }
    msg.textContent = "";

    for (const p of list){
      const name = safe(p.Name);
      const tags = [];

      if (norm(p.Pitcher) === "y") tags.push(`<span class="pill good">P</span>`);
      if (norm(p.Travel) === "y") {
        const lvl = safe(p.TravelLevel).toUpperCase();
        tags.push(`<span class="pill ${lvl === "A" ? "warn" : ""}">Travel${lvl ? " " + lvl : ""}</span>`);
      }

      const hoverKV = renderDetailsThreeCols(p);

      const div = document.createElement("div");
      div.className = "card playerRow";
      div.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div class="tightRow">
            <div class="tightLeft">
              <div class="tightName">${escapeHtml(name)}</div>
              <div class="tightMeta">${tags.join("")}</div>
            </div>
            <div class="smallMuted">Tap/click for details</div>
          </div>

          <div class="hoverCard" aria-hidden="true">
            <div style="font-weight:1000; margin-bottom:10px;">${escapeHtml(name)}</div>
            ${hoverKV}
          </div>
        </div>
      `;
      div.addEventListener("click", () => openModalForPlayer(p));
      el.appendChild(div);
    }
  }

  function renderTakenByTeam(rosterRows, teamsRows, playerMap){
    const onlySlug = safe(document.getElementById("takenTeamFilter")?.value);

    const el = document.getElementById("taken");
    const msg = document.getElementById("takenMsg");
    el.innerHTML = "";

    const slugToName = new Map();
    for (const t of teamsRows){
      const slug = safe(t.TeamSlug);
      const nm = safe(t.TeamName);
      if (slug) slugToName.set(slug, nm || slug);
    }

    const taken = rosterRows
      .map(r => ({
        slug: safe(r.TeamSlug),
        name: getRosterName(r),
        slot: safe(r.PlayerID),
        isCoachKid: (norm(r.CoachKid) === "y")
      }))
      .filter(x => x.slug && x.name)
      .filter(x => !onlySlug || x.slug === onlySlug);

    if (!taken.length){
      msg.textContent = onlySlug ? "No players taken yet for that team." : "No picks recorded yet (Roster tab still empty).";
      return;
    }
    msg.textContent = "";

    const byTeam = new Map();
    for (const x of taken){
      if (!byTeam.has(x.slug)) byTeam.set(x.slug, []);
      byTeam.get(x.slug).push(x);
    }

    const teams = [...byTeam.keys()].map(slug => ({
      slug,
      name: slugToName.get(slug) || slug
    })).sort((a,b) => a.name.localeCompare(b.name));

    for (const t of teams){
      const picks = byTeam.get(t.slug) || [];
      picks.sort((a,b) => a.slot.localeCompare(b.slot));

      let aCount = 0;
      for (const p of picks){
        const dp = playerMap.get(norm(p.name));
        if (dp && norm(dp.TravelLevel) === "a") aCount++;
      }
      const aBadge =
        aCount > 2
          ? `<span class="pill bad">A: ${aCount}/2</span>`
          : (aCount === 2 ? `<span class="pill warn">A: ${aCount}/2</span>` : `<span class="pill good">A: ${aCount}/2</span>`);

      const tColor = slugToColor.get(t.slug) || "";

      const section = document.createElement("div");
      section.className = "card";
      section.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div style="display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin-bottom:10px;">
            <div style="font-weight:1000; ${tColor ? `color:${escapeHtml(tColor)};` : ""}">${escapeHtml(t.name)}</div>
            ${aBadge}
          </div>
          <div style="display:grid; gap:6px;">
            ${picks.map(p => `
              <div class="smallMuted">
                <strong>${escapeHtml(p.slot || "—")}:</strong>
                ${escapeHtml(p.name)}${p.isCoachKid ? `<span class="fMark">(F)</span>` : ``}
              </div>
            `).join("")}
          </div>
        </div>
      `;
      el.appendChild(section);
    }
  }

  /* -----------------------------
     New ON-THE-CLOCK logic:
     Find first unfilled slot in pick sequence
     ----------------------------- */
  function computeClockFromRoster(pickSeq, rosterByTeamRound){
    // first index i where roster slot is empty
    let idx = 0;
    while (idx < pickSeq.length){
      const s = pickSeq[idx];
      const nm = rosterByTeamRound.get(`${s.teamSlug}|${s.round}`) || "";
      if (!nm) break;
      idx++;
    }

    const picksMade = idx;
    document.getElementById("picksMade").textContent = String(Math.max(0, picksMade));
    document.getElementById("totalRounds").textContent = String(TOTAL_ROUNDS);

    const cur = pickSeq[picksMade] || null;
    const nxt = pickSeq[picksMade + 1] || null;

    const onEl = document.getElementById("onClock");
    onEl.textContent = cur?.teamName || "—";

    if (cur?.teamSlug) {
      const c = slugToColor.get(cur.teamSlug);
      onEl.style.color = c ? c : "";
    } else {
      onEl.style.color = "";
    }

    document.getElementById("upNext").textContent = nxt?.teamName || "—";
    document.getElementById("round").textContent = cur ? String(cur.round) : "—";

    const pickPill = document.getElementById("pickPill");
    pickPill.textContent = cur ? ("Pick " + (picksMade + 1)) : "Pick —";
    pickPill.className = cur ? "pill" : "pill bad";

    return cur;
  }

  function populateSchoolOptions(pool){
    const sel = document.getElementById("schoolFilter");
    const prev = sel.value;

    const schools = Array.from(new Set(
      pool.map(p => safe(p.School)).filter(Boolean)
    )).sort((a,b) => a.localeCompare(b));

    sel.innerHTML =
      `<option value="">All</option>` +
      schools.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

    if (schools.includes(prev)) sel.value = prev;
    else sel.value = "";
  }

  function populateTakenTeamOptions(teams){
    const sel = document.getElementById("takenTeamFilter");
    const prev = sel.value;

    const opts = teams
      .map(t => ({ slug: safe(t.TeamSlug), name: safe(t.TeamName) }))
      .filter(t => t.slug && t.name)
      .sort((a,b) => a.name.localeCompare(b.name));

    sel.innerHTML =
      `<option value="">All teams</option>` +
      opts.map(t => `<option value="${escapeHtml(t.slug)}">${escapeHtml(t.name)}</option>`).join("");

    if (opts.some(t => t.slug === prev)) sel.value = prev;
    else sel.value = "";
  }

  function clearFilters(){
    document.getElementById("pitcherFilter").value = "";
    document.getElementById("travelFilter").value = "";
    document.getElementById("levelFilter").value = "";
    document.getElementById("schoolFilter").value = "";
    document.getElementById("takenTeamFilter").value = "";
    document.getElementById("springPitchingFilter").value = "";
    document.getElementById("springHittingFilter").value = "";
    document.getElementById("springThrowingFilter").value = "";
    document.getElementById("springFieldingFilter").value = "";
    document.getElementById("q").value = "";
  }

  function computeRosterIndexByTeamRound(rosterRows){
    // Map `${slug}|${round}` -> player name, based on PlayerID like "Or-01".."Or-12"
    const m = new Map();
    for (const r of rosterRows){
      const slug = safe(r.TeamSlug);
      const id = safe(r.PlayerID);
      const name = getRosterName(r);
      if (!slug || !id) continue;

      const mm = id.match(/-(\d{1,2})$/);
      if (!mm) continue;
      const round = Number(mm[1]);
      if (!Number.isFinite(round) || round < 1 || round > TOTAL_ROUNDS) continue;

      if (name) m.set(`${slug}|${round}`, name);
    }
    return m;
  }

  function computeRosterCoachKidByTeamRound(rosterRows){
    // Map `${slug}|${round}` -> boolean CoachKid (from Roster CSV column)
    const m = new Map();
    for (const r of rosterRows){
      const slug = safe(r.TeamSlug);
      const id = safe(r.PlayerID);
      if (!slug || !id) continue;

      const mm = id.match(/-(\d{1,2})$/);
      if (!mm) continue;
      const round = Number(mm[1]);
      if (!Number.isFinite(round) || round < 1 || round > TOTAL_ROUNDS) continue;

      const isCK = (norm(r.CoachKid) === "y");
      if (isCK) m.set(`${slug}|${round}`, true);
    }
    return m;
  }

  function renderDraftBoard(slots, rosterByTeamRound, rosterCoachKidByTeamRound, onClockPick){
    const el = document.getElementById("draftBoard");
    if (!el) return;
    el.innerHTML = "";

    const curSlug = onClockPick?.teamSlug || "";
    const curRound = onClockPick?.round || 0;

    const byRound = new Map();
    for (const s of slots){
      if (!byRound.has(s.round)) byRound.set(s.round, []);
      byRound.get(s.round).push(s);
    }

    for (let round = 1; round <= TOTAL_ROUNDS; round++){
      const rows = byRound.get(round) || [];
      if (!rows.length) continue;

      const roundCard = document.createElement("div");
      roundCard.className = "card";
      roundCard.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div class="boardRoundTitle">Round ${round}</div>
          <div class="boardRoundRows" style="display:grid; gap:8px;"></div>
        </div>
      `;
      const wrap = roundCard.querySelector(".boardRoundRows");

      for (const s of rows){
        const key = `${s.teamSlug}|${s.round}`;
        const rosterName = rosterByTeamRound.get(key) || "";
        const isClock = (s.teamSlug === curSlug && s.round === curRound);

        const tColor = slugToColor.get(s.teamSlug) || "";
        const tc = tColor || "rgba(0,0,0,.55)";

        const isCoachKidSlot = (rosterCoachKidByTeamRound.get(key) === true);
        const showF = isCoachKidSlot || s.isForfeit; // either roster says coach kid OR forfeits table marks slot

        let playerText = rosterName ? escapeHtml(rosterName) : "—";
        let playerClass = rosterName ? "boardPlayer" : "boardPlayer muted";

        if (showF && rosterName){
          playerText = `${escapeHtml(rosterName)} <span class="fMark">(F)</span>`;
          playerClass = "boardPlayer";
        } else if (showF && !rosterName){
          // rare: forfeited/coachkid slot but name missing
          playerText = `— <span class="fMark">(F)</span>`;
          playerClass = "boardPlayer muted";
        }

        const row = document.createElement("div");
        row.className = "boardRow" + (showF ? " forfeit" : "");
        if (isClock){
          row.style.borderColor = tc;
          row.style.borderWidth = "2px";
          row.style.boxShadow = `0 0 0 5px ${colorToRgba(tc, 0.18)}, 0 12px 28px rgba(0,0,0,.14)`;
          row.style.background = colorToRgba(tc, 0.06);
        }

        row.innerHTML = `
          <div class="boardLeft">
            <div class="boardPick">R${s.round} • ${String(s.posInRound).padStart(2,"0")}</div>
            <div class="boardTeam" style="${tColor ? `color:${escapeHtml(tColor)};` : ""}" title="${escapeHtml(s.teamName)}">
              ${escapeHtml(s.teamName)}
            </div>
          </div>
          <div class="${playerClass}" title="${escapeHtml(rosterName)}">${playerText}</div>
        `;
        wrap.appendChild(row);
      }

      el.appendChild(roundCard);
    }
  }

  /* -----------------------------
     Auto-refresh behavior:
     - preserve scroll position always
     - pause when scrolled down
     ----------------------------- */
  let autoTimer = null;
  let autoPausedByScroll = false;

  function updateAutoRefreshState(){
    const el = document.getElementById("autoRefreshState");
    if (!el) return;
    if (autoPausedByScroll) el.textContent = "PAUSED (scrolling)";
    else el.textContent = "ON";
  }

  function handleScrollPause(){
    const y = window.scrollY || 0;
    // If user is meaningfully down the page, pause auto refresh.
    const shouldPause = y > 220;
    if (shouldPause !== autoPausedByScroll){
      autoPausedByScroll = shouldPause;
      updateAutoRefreshState();
    }
  }
  window.addEventListener("scroll", handleScrollPause, { passive:true });

  async function loadAndRender(){
    // preserve scroll position to prevent “jump to top”
    const prevY = window.scrollY || 0;

    const meta = document.getElementById("meta");
    meta.textContent = "Loading…";

    const [teamsCsv, rosterCsv, poolCsv] = await Promise.all([
      fetchCsv(window.SHEET?.TEAMS_CSV_URL),
      fetchCsv(window.SHEET?.ROSTER_CSV_URL),
      fetchCsv(window.SHEET?.DRAFTPOOL_CSV_URL),
    ]);

    const teams = parseCsv(teamsCsv);
    const roster = parseCsv(rosterCsv);
    const poolRaw = parseCsv(poolCsv);

    slugToColor = new Map(
      teams
        .map(t => [safe(t.TeamSlug), safe(t.TeamColor)])
        .filter(([slug, color]) => slug && color)
    );

    const pool = poolRaw.map(p => {
      const out = {};
      for (const k of Object.keys(p)) out[k] = safe(p[k]);
      return out;
    });

    populateSchoolOptions(pool);
    populateTakenTeamOptions(teams);

    const playerMap = buildPlayerMap(pool);

    const takenNames = new Set(
      roster.map(getRosterName).filter(Boolean).map(n => norm(n))
    );

    const availableAll = pool.filter(p => p.Name && !takenNames.has(norm(p.Name)));
    const availableFiltered = applyFilters(availableAll);
    availableFiltered.sort((a,b) => safe(a.Name).localeCompare(safe(b.Name)));

    // compute forfeits (A=>1, B=>2, else=>8) based on coach kids on roster
    const forfeits = computeForfeits(teams, roster, playerMap);

    // compute sequence + on-the-clock based on first empty roster slot
    const rosterByTeamRound = computeRosterIndexByTeamRound(roster);
    const pickSeq = buildPickSequenceSnake(teams, forfeits);
    const onClockPick = computeClockFromRoster(pickSeq, rosterByTeamRound);

    // Header enhancements
    renderLastPicks(roster, teams);
    setTeamWash(onClockPick?.teamSlug);

    renderAvailable(availableFiltered);
    renderTakenByTeam(roster, teams, playerMap);

    // Draft order view (board)
    const rosterCoachKidByTeamRound = computeRosterCoachKidByTeamRound(roster);
    const boardSlots = buildBoardSlotsSnake(teams, forfeits);
    renderDraftBoard(boardSlots, rosterByTeamRound, rosterCoachKidByTeamRound, onClockPick);

    meta.textContent =
      `Available: ${availableAll.length} • Showing: ${availableFiltered.length} • Taken: ${takenNames.size} • Updated: ${new Date().toLocaleTimeString()}`;

    // restore scroll position (prevents jump)
    window.scrollTo({ top: prevY, left: 0, behavior: "auto" });
  }

  function init(){
    document.getElementById("refreshBtn")
      .addEventListener("click", () => loadAndRender().catch(err => alert(err.message)));

    document.getElementById("clearBtn")
      .addEventListener("click", () => {
        clearFilters();
        loadAndRender().catch(()=>{});
      });

    [
      "q",
      "pitcherFilter","travelFilter","levelFilter","schoolFilter","takenTeamFilter",
      "springPitchingFilter","springHittingFilter","springThrowingFilter","springFieldingFilter"
    ].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener("input", () => loadAndRender().catch(()=>{}));
      el.addEventListener("change", () => loadAndRender().catch(()=>{}));
    });

    document.getElementById("viewTakenBtn")?.addEventListener("click", () => setTakenView("team"));
    document.getElementById("viewBoardBtn")?.addEventListener("click", () => setTakenView("board"));
    setTakenView("team");

    updateAutoRefreshState();
    handleScrollPause();

    autoTimer = setInterval(() => {
      // Do not auto-refresh while user is scrolled down the page
      if (autoPausedByScroll) return;
      loadAndRender().catch(()=>{});
    }, 8000);

    loadAndRender().catch(err => {
      console.error(err);
      alert("Draft page error: " + err.message);
    });
  }

  init();
</script>

<script src="./nav.js"></script>
</body>
</html>
