<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draft • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026-draft-1" />
  <!-- optional: discourage indexing -->
  <meta name="robots" content="noindex,nofollow" />
</head>

<body class="watermarkPage draftPage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="siteNav">
      <span></span><span></span><span></span>
    </button>

    <div class="navOverlay" aria-hidden="true"></div>

    <!-- You can OMIT Draft from nav so parents won't see it -->
    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Draft Board</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">
    <div class="card">
      <div class="cardBody">

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
          <div style="flex:1; min-width:240px;">
            <div class="muted small">Search</div>
            <input id="q" type="text" placeholder="Type a name…" style="width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.12);" />
          </div>

          <div>
            <div class="muted small">Travel</div>
            <select id="travelFilter" style="padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.12);">
              <option value="">All</option>
              <option value="y">Travel (Y)</option>
              <option value="n">Non-travel (N)</option>
            </select>
          </div>

          <div>
            <div class="muted small">Travel Level</div>
            <select id="levelFilter" style="padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.12);">
              <option value="">All</option>
              <option value="a">A</option>
              <option value="b">B</option>
              <option value="none">None</option>
            </select>
          </div>

          <div>
            <div class="muted small">Pitcher</div>
            <select id="pitcherFilter" style="padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.12);">
              <option value="">All</option>
              <option value="y">Pitcher (Y)</option>
              <option value="n">Not marked</option>
            </select>
          </div>

          <button id="refreshBtn" class="btnSecondary" type="button">Refresh</button>
        </div>

        <div class="muted small" id="meta" style="margin-top:10px;"></div>

      </div>
    </div>

    <!-- Draft clock / who is on the clock -->
    <div class="card" style="margin-top:14px;">
      <div class="cardBody">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
          <div>
            <div style="font-weight:900;">On the clock: <span id="onClock">—</span></div>
            <div class="muted small">Up next: <span id="upNext">—</span> • Round: <span id="round">—</span></div>
          </div>
          <div class="muted small">Auto-refresh: <span id="autoRefreshState">ON</span></div>
        </div>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px; margin-top:14px;">
      <div class="card">
        <div class="cardBody">
          <h2 style="margin:0 0 10px 0;">Available</h2>
          <div id="available" style="display:grid; gap:10px;"></div>
          <p id="availMsg" class="muted small" style="margin-top:10px;"></p>
        </div>
      </div>

      <div class="card">
        <div class="cardBody">
          <h2 style="margin:0 0 10px 0;">Taken (by team)</h2>
          <div id="taken" style="display:grid; gap:12px;"></div>
          <p id="takenMsg" class="muted small" style="margin-top:10px;"></p>
        </div>
      </div>
    </div>

  </section>
</main>

<script src="./data.js"></script>
<script>
  function safe(v){ return String(v ?? "").trim(); }
  function norm(v){ return safe(v).toLowerCase(); }

  async function fetchCsv(url){
    if (!url) throw new Error("Missing CSV URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache:"no-store" });
    if (!res.ok) throw new Error("Failed to fetch CSV: " + res.status);
    return await res.text();
  }

  // Robust CSV parser (quoted commas safe) — matches your other pages’ approach
  function parseCsv(text){
    const rows = [];
    let row = [], cur = "", inQuotes = false;
    for (let i=0; i<text.length; i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if (!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }
      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }
      cur += ch;
    }
    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g,""));
    return rows.map(r => {
      const o = {};
      headers.forEach((h, idx) => o[h] = safe(r[idx]));
      return o;
    }).filter(o => Object.values(o).some(v => safe(v) !== ""));
  }

  function getRosterName(r){
    return safe(r.PlayerName || r.Name);
  }

  function cardLine(label, value){
    const v = safe(value);
    if (!v) return "";
    return `<div class="muted small"><strong>${label}:</strong> ${v}</div>`;
  }

  function renderAvailable(list){
    const el = document.getElementById("available");
    const msg = document.getElementById("availMsg");
    el.innerHTML = "";

    if (!list.length){
      msg.textContent = "No available players match the current filters.";
      return;
    }
    msg.textContent = "";

    for (const p of list){
      const name = safe(p.Name);
      const travel = safe(p.Travel);
      const travelTeam = safe(p.TravelTeam);
      const level = safe(p.TravelLevel);
      const pitcher = safe(p.Pitcher);
      const notes = safe(p.Notes);

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div style="font-weight:900; margin-bottom:6px;">${name}</div>
          ${cardLine("Travel", travel)}
          ${cardLine("Travel Team", travelTeam)}
          ${cardLine("Level", level)}
          ${cardLine("Pitcher", pitcher)}
          ${notes ? `<div class="muted small" style="margin-top:6px;">${notes}</div>` : ""}
        </div>
      `;
      el.appendChild(div);
    }
  }

  function renderTakenByTeam(rosterRows, teamsRows){
    const el = document.getElementById("taken");
    const msg = document.getElementById("takenMsg");
    el.innerHTML = "";

    const slugToName = new Map();
    for (const t of teamsRows){
      const slug = safe(t.TeamSlug);
      const nm = safe(t.TeamName);
      if (slug) slugToName.set(slug, nm || slug);
    }

    const taken = rosterRows
      .map(r => ({
        slug: safe(r.TeamSlug),
        name: getRosterName(r),
        slot: safe(r.PlayerID) // your pre-populated slot ids (Or-01, etc.)
      }))
      .filter(x => x.slug && x.name);

    if (!taken.length){
      msg.textContent = "No picks recorded yet (Roster tab still empty).";
      return;
    }
    msg.textContent = "";

    // group by team slug
    const byTeam = new Map();
    for (const x of taken){
      if (!byTeam.has(x.slug)) byTeam.set(x.slug, []);
      byTeam.get(x.slug).push(x);
    }

    // render teams in a stable order (alphabetical by display name)
    const teams = [...byTeam.keys()].map(slug => ({
      slug,
      name: slugToName.get(slug) || slug
    })).sort((a,b) => a.name.localeCompare(b.name));

    for (const t of teams){
      const picks = byTeam.get(t.slug) || [];
      picks.sort((a,b) => a.slot.localeCompare(b.slot)); // stable within team (Or-01..Or-12)

      const section = document.createElement("div");
      section.className = "card";
      section.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div style="font-weight:900; margin-bottom:8px;">${t.name}</div>
          <div style="display:grid; gap:6px;">
            ${picks.map(p => `
              <div class="muted small">
                <strong>${p.slot || "—"}:</strong> ${p.name}
              </div>
            `).join("")}
          </div>
        </div>
      `;
      el.appendChild(section);
    }
  }

  function applyFilters(players){
    const q = norm(document.getElementById("q").value);
    const travel = norm(document.getElementById("travelFilter").value);
    const level = norm(document.getElementById("levelFilter").value);
    const pitcher = norm(document.getElementById("pitcherFilter").value);

    return players.filter(p => {
      const name = norm(p.Name);
      if (q && !name.includes(q)) return false;

      const tr = norm(p.Travel);
      if (travel === "y" && tr !== "y") return false;
      if (travel === "n" && tr === "y") return false;

      const lv = norm(p.TravelLevel);
      if (level && lv !== level) return false;

      const pi = norm(p.Pitcher);
      if (pitcher === "y" && pi !== "y") return false;
      if (pitcher === "n" && pi === "y") return false;

      return true;
    });
  }

  function computeDraftClock(teamsRows, rosterRows){
    // Simple “snake-less” clock: counts total picks and maps to team list order.
    // If you want snake draft / custom order, we’ll add a DraftOrder tab later.
    const teamOrder = teamsRows
      .map(t => ({ slug: safe(t.TeamSlug), name: safe(t.TeamName) }))
      .filter(t => t.slug);

    const takenCount = rosterRows.filter(r => getRosterName(r)).length;

    const onIdx = takenCount % teamOrder.length;
    const nextIdx = (onIdx + 1) % teamOrder.length;
    const round = Math.floor(takenCount / teamOrder.length) + 1;

    document.getElementById("onClock").textContent = teamOrder[onIdx]?.name || "—";
    document.getElementById("upNext").textContent = teamOrder[nextIdx]?.name || "—";
    document.getElementById("round").textContent = String(round);
  }

  let autoTimer = null;

  async function loadAndRender(){
    const meta = document.getElementById("meta");
    meta.textContent = "Loading…";

    const [teamsCsv, rosterCsv, poolCsv] = await Promise.all([
      fetchCsv(window.SHEET?.TEAMS_CSV_URL),
      fetchCsv(window.SHEET?.ROSTER_CSV_URL),
      fetchCsv(window.SHEET?.DRAFTPOOL_CSV_URL),
    ]);

    const teams = parseCsv(teamsCsv);
    const roster = parseCsv(rosterCsv);
    const pool = parseCsv(poolCsv);

    const takenNames = new Set(
      roster.map(getRosterName).filter(Boolean).map(n => norm(n))
    );

    const available = pool
      .map(p => ({
        Name: safe(p.Name),
        Travel: safe(p.Travel),
        TravelTeam: safe(p.TravelTeam),
        TravelLevel: safe(p.TravelLevel),
        Pitcher: safe(p.Pitcher),
        Notes: safe(p.Notes),
      }))
      .filter(p => p.Name && !takenNames.has(norm(p.Name)));

    const filteredAvailable = applyFilters(available);

    renderAvailable(filteredAvailable);
    renderTakenByTeam(roster, teams);
    computeDraftClock(teams, roster);

    meta.textContent =
      `Available: ${available.length} • Showing: ${filteredAvailable.length} • Taken: ${takenNames.size} • Updated: ${new Date().toLocaleTimeString()}`;
  }

  function init(){
    const refreshBtn = document.getElementById("refreshBtn");
    refreshBtn.addEventListener("click", () => loadAndRender().catch(err => alert(err.message)));

    ["q","travelFilter","levelFilter","pitcherFilter"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => loadAndRender().catch(()=>{}));
      document.getElementById(id).addEventListener("change", () => loadAndRender().catch(()=>{}));
    });

    // Auto-refresh every 8 seconds during draft
    autoTimer = setInterval(() => loadAndRender().catch(()=>{}), 8000);

    loadAndRender().catch(err => {
      console.error(err);
      alert("Draft page error: " + err.message);
    });
  }

  init();
</script>

<script src="./nav.js"></script>
</body>
</html>
