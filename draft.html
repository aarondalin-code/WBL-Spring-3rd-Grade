<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draft • WBL 3rd Grade 2026</title>

  <link rel="stylesheet" href="styles.css?v=wbl2026-draft-13" />

  <style>
    /* Minimal local styles; main layout in styles.css */
    .draftPage .pillTabs{
      display:flex;
      gap:6px;
      background: rgba(0,0,0,.06);
      padding:5px;
      border-radius:999px;
      align-items:center;
    }
    .draftPage .pillTab{
      appearance:none;
      border:0;
      background: transparent;
      padding:7px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      color: rgba(0,0,0,.75);
    }
    .draftPage .pillTab.active{
      background:#fff;
      box-shadow: 0 1px 2px rgba(0,0,0,.10);
      color: rgba(0,0,0,.92);
    }
    .draftPage .boardRoundTitle{
      font-weight:1000;
      margin: 2px 0 10px 0;
    }
    .draftPage .boardRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border:1px solid rgba(0,0,0,.10);
      border-radius:12px;
      background:#fff;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    .draftPage .boardLeft{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .draftPage .boardPick{
      font-variant-numeric: tabular-nums;
      font-weight:900;
      color: rgba(0,0,0,.65);
      min-width: 86px;
    }
    .draftPage .boardTeam{
      font-weight:1000;
      white-space:nowrap;
    }
    .draftPage .boardPlayer{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color: rgba(0,0,0,.85);
      font-weight:800;
    }
    .draftPage .boardPlayer.muted{
      color: rgba(0,0,0,.40);
      font-weight:800;
    }
    .draftPage .boardRow.onclock{
      outline: none;
    }
    .draftPage .boardRow.forfeit{
      background: rgba(0,0,0,.03);
    }
.draftPage .pill.good{ border-color: rgba(0,150,80,.35); }
    .draftPage .pill.warn{ border-color: rgba(200,120,0,.45); }
    .draftPage .pill.bad { border-color: rgba(190,40,40,.45); }

    .draftPage .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .draftPage .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .draftPage .grid2{ grid-template-columns: 1fr; }
    }

    .draftPage .ticker{
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background:#fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
    }
    .draftPage .tickerRow{
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px 12px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
    }
    .draftPage .tickerRow::-webkit-scrollbar{ display:none; }
    .draftPage .tick{
      flex: 0 0 auto;
      scroll-snap-align: start;
      display:flex;
      gap:10px;
      align-items:center;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      background: rgba(0,0,0,.02);
      min-width: 220px;
    }
    .draftPage .tick .team{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 110px;
    }
    .draftPage .tick .player{
      color: rgba(0,0,0,.72);
      font-weight: 800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 140px;
    }
    .draftPage .tick .sep{ color: rgba(0,0,0,.28); }

    /* Modal */
    .modalBackdrop{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .modalBackdrop.open{ display:flex; }
    .modalCard{
      width: min(880px, 100%);
      max-height: min(84vh, 820px);
      background:#fff;
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 18px 48px rgba(0,0,0,.32);
      display:flex;
      flex-direction:column;
    }
    .modalHdr{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    .modalTitle{
      font-weight: 1000;
      font-size: 18px;
      margin-right: 10px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .xBtn{
      appearance:none;
      border:1px solid rgba(0,0,0,.15);
      background: rgba(0,0,0,.02);
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 900;
      cursor:pointer;
    }
    .modalBody{
      padding: 14px 16px;
      overflow:auto;
    }
    .kvGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .kvGrid{ grid-template-columns: 1fr; }
    }
    .kvCol{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,.015);
    }
    .kvRow{
      display:flex;
      justify-content:space-between;
      gap: 12px;
      padding: 7px 0;
      border-bottom: 1px dashed rgba(0,0,0,.10);
    }
    .kvRow:last-child{ border-bottom:0; }
    .k{ color: rgba(0,0,0,.55); font-weight: 900; }
    .v{ color: rgba(0,0,0,.86); font-weight: 900; text-align:right; }
    .smallMuted{ color: rgba(0,0,0,.55); font-weight: 800; font-size: 12px; }

    /* Player cards */
    .playerCard{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      background:#fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .12s ease;
    }
    .playerCard:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,.10); }
    .pName{ font-weight: 1000; font-size: 16px; }
    .pMeta{ display:flex; flex-wrap:wrap; gap: 6px; }
    .pill{
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 999px;
      padding: 4px 8px;
      font-weight: 900;
      font-size: 12px;
      background: rgba(0,0,0,.02);
      color: rgba(0,0,0,.78);
    }
    .pill.muted{
      color: rgba(0,0,0,.45);
      background: rgba(0,0,0,.015);
    }

    /* Taken */
    .takenTeamCard{
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 16px;
      background:#fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .takenHdr{
      padding: 12px 12px 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(0,0,0,.08);
      gap: 10px;
    }
    .takenHdr .tName{
      font-weight: 1000;
      font-size: 15px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .takenList{
      padding: 8px 12px 12px 12px;
      display:grid;
      gap: 6px;
    }
    .takenItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border: 1px solid rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 8px 10px;
      background: rgba(0,0,0,.01);
    }
    .takenItem .idx{
      font-variant-numeric: tabular-nums;
      font-weight: 1000;
      color: rgba(0,0,0,.55);
      min-width: 22px;
    }
    .takenItem .nm{
      flex:1;
      font-weight: 900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color: rgba(0,0,0,.80);
    }
    .takenItem .tag{
      font-weight: 900;
      font-size: 12px;
      color: rgba(0,0,0,.55);
      white-space:nowrap;
    }
  </style>
</head>

<body class="draftPage">
<main class="wrap" style="max-width: 1180px; margin: 0 auto; padding: 18px 14px 50px 14px;">

  <section style="display:grid; gap: 12px;">

    <!-- Header -->
    <div class="card">
      <div class="cardBody" style="padding: 14px 14px 12px 14px;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap: 10px; flex-wrap:wrap;">
          <div>
            <div class="smallMuted">WBL 3rd Grade 2026 • Draft</div>
            <div style="font-weight: 1100; font-size: 22px; line-height:1.1; margin-top: 6px;">Live Draft Board</div>
          </div>

          <div style="display:flex; gap: 8px; align-items:center; flex-wrap:wrap;">
            <button id="refreshBtn" class="xBtn" type="button" title="Refresh now">Refresh</button>
            <button id="clearBtn" class="xBtn" type="button" title="Clear filters">Clear</button>
          </div>
        </div>

        <div style="height: 10px;"></div>

        <!-- On the clock -->
        <div class="grid2">
          <div class="card" id="otcCard" style="margin:0;">
            <div class="cardBody" style="padding: 14px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap:wrap;">
                <div style="flex:1; min-width: 240px;">
                  <div style="text-align:center; font-weight:1000; font-size: 14px; color: rgba(0,0,0,.62);">On the clock:</div>
                  <div id="otcTeam" style="text-align:center; font-weight: 1200; font-size: 24px; margin-top: 4px;">—</div>
                  <div id="otcMeta" class="smallMuted" style="text-align:center; margin-top: 4px;">—</div>
                </div>
                <div style="display:flex; align-items:center; justify-content:center; gap: 8px; min-width: 160px; flex-wrap:wrap;">
                  <span class="pill" id="pickPill">Pick —</span>
                  <span class="pill" id="roundPill">Round —</span>
                </div>
              </div>

              <div style="height: 10px;"></div>

              <!-- Last 5 picks ticker -->
              <div class="ticker" aria-label="Last 5 picks">
                <div class="tickerRow" id="tickerRow"></div>
              </div>
              <div class="smallMuted" style="margin-top: 6px;">Last 5 picks (swipe on mobile)</div>
            </div>
          </div>

          <!-- Filters -->
          <div class="card" style="margin:0;">
            <div class="cardBody" style="padding: 14px;">
              <div style="font-weight: 1000; margin-bottom: 10px;">Filters</div>

              <div class="grid3">
                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Name</span>
                  <input id="q" type="text" placeholder="Search name…" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);" />
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Pitcher</span>
                  <select id="pitcherFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                    <option value="y">Pitcher</option>
                    <option value="n">Not pitcher</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Travel</span>
                  <select id="travelFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                    <option value="y">Travel</option>
                    <option value="n">Non-travel</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Travel Level</span>
                  <select id="levelFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                    <option value="a">A</option>
                    <option value="b">B</option>
                    <option value="c">C</option>
                    <option value="none">None</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">School</span>
                  <select id="schoolFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Taken Team</span>
                  <select id="takenTeamFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All teams</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Spring Pitching</span>
                  <select id="springPitchingFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                    <option value="y">Yes</option>
                    <option value="n">No</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Spring Hitting</span>
                  <select id="springHittingFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                    <option value="y">Yes</option>
                    <option value="n">No</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Spring Throwing</span>
                  <select id="springThrowingFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                    <option value="y">Yes</option>
                    <option value="n">No</option>
                  </select>
                </label>

                <label style="display:flex; flex-direction:column; gap:6px;">
                  <span class="smallMuted">Spring Fielding</span>
                  <select id="springFieldingFilter" style="padding:10px 10px; border-radius:12px; border:1px solid rgba(0,0,0,.15);">
                    <option value="">All</option>
                    <option value="y">Yes</option>
                    <option value="n">No</option>
                  </select>
                </label>
              </div>

              <div class="smallMuted" style="margin-top: 10px;">
                Picks are recorded by typing the player name into the team’s roster slot (e.g., Or-01 … Or-12).
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="grid2">
      <!-- Available -->
      <div class="card">
        <div class="cardBody" style="padding: 14px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap:wrap;">
            <h2 style="margin:0;">Available</h2>
            <div class="smallMuted" id="availCount">—</div>
          </div>
          <div style="height: 10px;"></div>
          <div id="available" style="display:grid; gap:12px;"></div>
          <p id="availMsg" class="smallMuted" style="margin-top:10px;"></p>
        </div>
      </div>

      <!-- Taken -->
      <div class="card">
        <div class="cardBody" style="padding: 14px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap:wrap;">
            <h2 style="margin:0;">Taken</h2>
            <div class="pillTabs" id="takenViewTabs" aria-label="Taken view toggle">
              <button id="viewTakenBtn" class="pillTab active" type="button" aria-pressed="true">By team</button>
              <button id="viewBoardBtn" class="pillTab" type="button" aria-pressed="false">Draft order</button>
            </div>
          </div>
          <div id="taken" style="display:grid; gap:12px;"></div>
          <div id="draftBoard" style="display:none; gap:12px;"></div>
          <p id="takenMsg" class="smallMuted" style="margin-top:10px;"></p>
        </div>
      </div>
    </div>

  </section>
</main>

<div class="modalBackdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHdr">
      <div class="modalTitle" id="modalTitle">Player</div>
      <button class="xBtn" id="modalClose" type="button">Close</button>
    </div>
    <div class="modalBody">
      <div id="modalTags" class="smallMuted" style="margin-bottom:10px;"></div>
      <div id="modalKV"></div>
    </div>
  </div>
</div>

<script src="data.js?v=wbl2026-draft-13"></script>

<script>
  // ===== Config =====
  const TOTAL_TEAMS = 10;
  const TOTAL_ROUNDS = 12;

  // CoachKid forfeit rules:
  // A => base round 1 forfeited; B => base round 2 forfeited.
  // If two coach kids exist, push duplicates forward to avoid collisions.
  const COACHKID_FORFEIT_BASE = { "A": 1, "B": 2 };

  // Detail panel schema: 3 cols x 5 fields each.
  const DETAIL_SCHEMA = [
    ["School", "Travel", "TravelLevel", "Pitcher", "TakenTeam"],
    ["SpringPitching", "SpringHitting", "SpringThrowing", "SpringFielding", "Notes"],
    ["Height", "Weight", "Bats", "Throws", "Other"]
  ];

  // ===== Helpers =====
  function safe(v){ return (v ?? "").toString().trim(); }
  function norm(v){ return safe(v).toLowerCase(); }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function colorToRgba(color, alpha){
    // Supports: #RGB, #RRGGBB, rgb(), rgba(). Falls back to black if unknown.
    const c = (color ?? "").toString().trim();
    const a = Math.max(0, Math.min(1, Number(alpha)));
    if (!c) return `rgba(0,0,0,${a})`;

    // Hex
    const hex = c.startsWith("#") ? c.slice(1) : "";
    if (hex && (hex.length === 3 || hex.length === 6)){
      const h = hex.length === 3 ? hex.split("").map(ch => ch+ch).join("") : hex;
      const r = parseInt(h.slice(0,2), 16);
      const g = parseInt(h.slice(2,4), 16);
      const b = parseInt(h.slice(4,6), 16);
      if ([r,g,b].every(n => Number.isFinite(n))) return `rgba(${r},${g},${b},${a})`;
    }

    // rgb/rgba
    const m = c.match(/^rgba?\(([^)]+)\)$/i);
    if (m){
      const parts = m[1].split(",").map(x => x.trim());
      const r = Number(parts[0]);
      const g = Number(parts[1]);
      const b = Number(parts[2]);
      if ([r,g,b].every(n => Number.isFinite(n))) return `rgba(${r},${g},${b},${a})`;
    }

    return `rgba(0,0,0,${a})`;
  }


  async function fetchCsv(url){
    if (!url) throw new Error("Missing CSV URL in data.js (check window.SHEET.*)");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache:"no-store" });
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    const txt = await res.text();
    return parseCsv(txt);
  }

  function parseCsv(txt){
    // A small CSV parser that handles quoted fields and commas/newlines inside quotes.
    const rows = [];
    let cur = [];
    let field = "";
    let inQ = false;

    for (let i = 0; i < txt.length; i++){
      const ch = txt[i];
      const nxt = txt[i+1];

      if (inQ){
        if (ch === '"' && nxt === '"'){
          field += '"';
          i++;
        } else if (ch === '"'){
          inQ = false;
        } else {
          field += ch;
        }
      } else {
        if (ch === '"'){
          inQ = true;
        } else if (ch === ","){
          cur.push(field);
          field = "";
        } else if (ch === "\n"){
          cur.push(field);
          rows.push(cur);
          cur = [];
          field = "";
        } else if (ch === "\r"){
          // ignore
        } else {
          field += ch;
        }
      }
    }
    cur.push(field);
    rows.push(cur);

    // Remove empty trailing rows
    while (rows.length && rows[rows.length-1].every(x => safe(x)==="")) rows.pop();

    if (!rows.length) return [];
    const hdr = rows[0].map(h => safe(h).replace(/\s+/g,""));
    const out = [];
    for (let r = 1; r < rows.length; r++){
      const obj = {};
      const row = rows[r];
      for (let c = 0; c < hdr.length; c++){
        obj[hdr[c]] = row[c] ?? "";
      }
      out.push(obj);
    }
    return out;
  }

  // ===== State =====
  let TEAMS = [];
  let TEAM_BY_SLUG = new Map();
  let TEAM_COLOR_BY_SLUG = new Map();
  let TAKEN_VIEW = "team"; // "team" or "board"

  function teamColor(slug){ return TEAM_COLOR_BY_SLUG.get(slug) || ""; }

  function buildPickSequence(teams){
    // Snake draft: round 1 = order, round 2 = reverse, etc.
    const seq = [];
    const order = teams.slice(); // assumed already in draft order
    const rev = teams.slice().reverse();
    for (let round = 1; round <= TOTAL_ROUNDS; round++){
      const list = (round % 2 === 1) ? order : rev;
      for (let pos = 0; pos < list.length; pos++){
        const t = list[pos];
        seq.push({
          round,
          posInRound: pos+1,
          teamSlug: t.TeamSlug,
          teamName: t.TeamName
        });
      }
    }
    return seq;
  }

  function computeForfeitsFromRoster(rosterRows){
    // Determine CoachKid travel level for each team, based on roster entries with CoachKid flag / or TravelLevel? 
    // The implementation here expects Roster rows may include:
    // - TeamSlug
    // - CoachKid (Y/N) or IsCoachKid
    // - TravelLevel (A/B/C/None)
    // But your current workflow is "type name into Or-01..Or-12", and coach kids are already on the roster.
    //
    // We handle "CoachKid forfeits" based on DraftPool fields when we can match names, otherwise no forfeits.
    //
    // For this page, forfeits are driven by DraftPool entries with CoachKid + TravelLevel and then matched to roster.
    // We'll return a map: teamSlug -> set(roundNumbers forfeited)
    return new Map();
  }

  function computeForfeitsFromCoachKids(takenPlayersByTeam){
    // takenPlayersByTeam: Map teamSlug -> array of player objects (taken)
    // Determine which rounds are forfeited based on coach kids' travel levels.
    const forfeitsByTeam = new Map();

    for (const [slug, arr] of takenPlayersByTeam.entries()){
      // Identify coach kids: any taken player with CoachKid==Y (or "y")
      const coachKids = arr.filter(p => norm(p.CoachKid || p.IsCoachKid) === "y");
      if (!coachKids.length) continue;

      // Collect desired forfeit rounds.
      const used = new Set();
      const rounds = [];
      for (const ck of coachKids){
        const lv = safe(ck.TravelLevel || ck.Level || ck.TravelLvl).toUpperCase();
        const base = COACHKID_FORFEIT_BASE[lv];
        if (!base) continue;

        let r = base;
        while (used.has(r) && r <= TOTAL_ROUNDS) r++;
        if (r <= TOTAL_ROUNDS){
          used.add(r);
          rounds.push(r);
        }
      }
      if (rounds.length) forfeitsByTeam.set(slug, new Set(rounds));
    }

    return forfeitsByTeam;
  }

  function computeRosterIndex(rosterRows){
    // Maps by (teamSlug|round) => playerName (typed into that slot)
    const m = new Map();
    for (const r of rosterRows){
      const slug = safe(r.TeamSlug);
      const id = safe(r.PlayerID);
      const name = safe(r.PlayerName || r.Name);
      if (!slug) continue;
      if (!id) continue;

      // id pattern: Or-01..Or-12, etc.
      const mm = id.match(/-(\d{1,2})$/);
      if (!mm) continue;
      const round = Number(mm[1]);
      if (!Number.isFinite(round) || round < 1 || round > TOTAL_ROUNDS) continue;

      m.set(`${slug}|${round}`, name);
    }
    return m;
  }

  function buildBoardSlots(teams, forfeitsByTeam){
    // Returns a list of slots in snake pick order, but with a "forfeit" flag per slot.
    // Forfeits do NOT remove the pick from the sequence; they mark it and display FORFEIT.
    const seq = buildPickSequence(teams);
    const slots = [];
    for (const s of seq){
      const fset = forfeitsByTeam.get(s.teamSlug);
      const isForfeit = fset ? fset.has(s.round) : false;
      slots.push({ ...s, isForfeit });
    }
    return slots;
  }

  function calcPicksMade(rosterRows){
    // picksMade is roster entries with non-empty PlayerName (or Name),
    // excluding coach kids? The earlier baseline subtracted coach kids on roster.
    // We'll keep that behavior:
    // if roster row has CoachKid==Y, do not count it toward picksMade.
    let n = 0;
    for (const r of rosterRows){
      const name = safe(r.PlayerName || r.Name);
      if (!name) continue;

      const isCoachKid = norm(r.CoachKid || r.IsCoachKid) === "y";
      if (isCoachKid) continue;
      n++;
    }
    return n;
  }

  function buildPlayerMap(draftPool){
    // Map by normalized name => player object
    const m = new Map();
    for (const p of draftPool){
      const nm = norm(p.Name);
      if (!nm) continue;
      if (!m.has(nm)) m.set(nm, p);
    }
    return m;
  }

  function buildTakenByTeam(rosterRows, playerMap){
    // Map teamSlug -> array of player objects (from DraftPool when possible; else minimal objects)
    const m = new Map();
    for (const r of rosterRows){
      const slug = safe(r.TeamSlug);
      if (!slug) continue;
      const nm = safe(r.PlayerName || r.Name);
      if (!nm) continue;

      const key = norm(nm);
      const full = playerMap.get(key) || { Name: nm };

      if (!m.has(slug)) m.set(slug, []);
      // Attach TakenTeam for filter and display
      const obj = { ...full, TakenTeam: slug };
      m.get(slug).push(obj);
    }
    return m;
  }

  function renderTicker(lastPicks){
    const row = document.getElementById("tickerRow");
    if (!row) return;
    row.innerHTML = "";
    if (!lastPicks.length){
      row.innerHTML = `<div class="smallMuted" style="padding:10px 12px;">No picks yet.</div>`;
      return;
    }
    for (const p of lastPicks){
      const tcol = teamColor(p.teamSlug);
      const el = document.createElement("div");
      el.className = "tick";
      el.innerHTML = `
        <div class="team" style="${tcol ? `color:${escapeHtml(tcol)};` : ""}">${escapeHtml(p.teamName)}</div>
        <div class="sep">•</div>
        <div class="player">${escapeHtml(p.playerName)}</div>
      `;
      row.appendChild(el);
    }
  }

  function renderAvailable(players){
    const el = document.getElementById("available");
    const msg = document.getElementById("availMsg");
    const count = document.getElementById("availCount");
    if (!el) return;

    el.innerHTML = "";
    count.textContent = `${players.length} players`;
    msg.textContent = players.length ? "" : "No available players match your filters.";

    for (const p of players){
      const card = document.createElement("div");
      card.className = "playerCard";
      card.dataset.name = safe(p.Name);

      const pills = [];
      if (norm(p.Pitcher) === "y") pills.push(`<span class="pill">Pitcher</span>`);
      if (norm(p.Travel) === "y"){
        const lv = safe(p.TravelLevel).toUpperCase() || "Travel";
        pills.push(`<span class="pill">${escapeHtml(lv)} travel</span>`);
      } else {
        pills.push(`<span class="pill muted">Non-travel</span>`);
      }
      if (safe(p.School)) pills.push(`<span class="pill">${escapeHtml(p.School)}</span>`);

      card.innerHTML = `
        <div class="pName">${escapeHtml(p.Name || "Unnamed")}</div>
        <div class="pMeta">${pills.join("")}</div>
        <div class="smallMuted">Tap for details</div>
      `;

      card.addEventListener("click", () => openModal(p));
      el.appendChild(card);
    }
  }

  function renderTakenByTeam(takenByTeam, forfeitsByTeam){
    const el = document.getElementById("taken");
    const msg = document.getElementById("takenMsg");
    if (!el) return;

    el.innerHTML = "";
    msg.textContent = "";

    // Build dropdown options for Taken Team filter
    const takenSelect = document.getElementById("takenTeamFilter");
    if (takenSelect){
      const cur = safe(takenSelect.value);
      takenSelect.innerHTML = `<option value="">All teams</option>` +
        TEAMS.map(t => `<option value="${escapeHtml(t.TeamSlug)}">${escapeHtml(t.TeamName)}</option>`).join("");
      takenSelect.value = cur;
    }

    const filterSlug = safe(document.getElementById("takenTeamFilter")?.value);

    let any = false;
    for (const t of TEAMS){
      const slug = safe(t.TeamSlug);
      if (filterSlug && filterSlug !== slug) continue;

      const arr = takenByTeam.get(slug) || [];
      const fset = forfeitsByTeam.get(slug) || new Set();
      any = true;

      const card = document.createElement("div");
      card.className = "takenTeamCard";

      const aCount = arr.filter(p => safe(p.TravelLevel).toUpperCase() === "A").length;
      const capClass = aCount > 2 ? "pill bad" : (aCount === 2 ? "pill warn" : "pill good");

      const tcol = teamColor(slug);

      card.innerHTML = `
        <div class="takenHdr">
          <div class="tName" style="${tcol ? `color:${escapeHtml(tcol)};` : ""}" title="${escapeHtml(t.TeamName)}">${escapeHtml(t.TeamName)}</div>
          <div style="display:flex; gap:6px; align-items:center;">
            <span class="pill">${arr.length} picks</span>
            <span class="${capClass}">A cap: ${aCount}/2</span>
          </div>
        </div>
        <div class="takenList"></div>
      `;

      const list = card.querySelector(".takenList");

      // Show by rounds for readability: 1..12
      for (let r = 1; r <= TOTAL_ROUNDS; r++){
        const key = `${slug}|${r}`;
        const pick = arr.find(p => true); // placeholder; list order is roster order in sheet
        // We don't have stable per-round mapping here; we show in listed order.
      }

      // Display in the order they appear (Roster order)
      arr.forEach((p, idx) => {
        const li = document.createElement("div");
        li.className = "takenItem";
        const nm = safe(p.Name);
        li.innerHTML = `
          <div class="idx">${idx+1}</div>
          <div class="nm" title="${escapeHtml(nm)}">${escapeHtml(nm)}</div>
          <div class="tag">${escapeHtml(safe(p.TravelLevel || "").toUpperCase())}</div>
        `;
        li.addEventListener("click", () => openModal(p));
        list.appendChild(li);
      });

      // Show forfeits (if any) as a footer note
      if (fset.size){
        const note = document.createElement("div");
        note.className = "smallMuted";
        note.style.padding = "0 12px 12px 12px";
        note.textContent = "Forfeits: Round " + Array.from(fset).sort((a,b)=>a-b).join(", ");
        card.appendChild(note);
      }

      el.appendChild(card);
    }

    if (!any){
      msg.textContent = "No taken players yet.";
    }
  }

  function renderDraftBoard(boardSlots, rosterByTeamRound, forfeits, playerMap, pickSeq, picksMade){
    const el = document.getElementById("draftBoard");
    const msg = document.getElementById("takenMsg");
    if (!el) return;
    el.innerHTML = "";

    if (!boardSlots.length){
      msg.textContent = "Draft board unavailable (no teams loaded).";
      return;
    }
    msg.textContent = "";

    // Determine current on-the-clock team+round for highlight.
    const cur = pickSeq[picksMade];
    const curRound = cur?.round;
    const curSlug = cur?.teamSlug;

    // Group by round.
    const byRound = new Map();
    for (const s of boardSlots){
      if (!byRound.has(s.round)) byRound.set(s.round, []);
      byRound.get(s.round).push(s);
    }

    for (let round = 1; round <= TOTAL_ROUNDS; round++){
      const rows = byRound.get(round) || [];
      if (!rows.length) continue;

      const roundCard = document.createElement("div");
      roundCard.className = "card";
      roundCard.innerHTML = `
        <div class="cardBody" style="padding:12px;">
          <div class="boardRoundTitle">Round ${round}</div>
          <div class="boardRoundRows" style="display:grid; gap:8px;"></div>
        </div>
      `;
      const wrap = roundCard.querySelector(".boardRoundRows");

      // For pick numbering, show overall slot number including forfeits.
      for (let i = 0; i < rows.length; i++){
        const s = rows[i];
        const key = `${s.teamSlug}|${s.round}`;
        const rosterName = rosterByTeamRound.get(key) || "";
        const isClock = (s.round === curRound && s.teamSlug === curSlug);
        const c = teamColor(s.teamSlug);

        let playerText = rosterName ? escapeHtml(rosterName) : "—";
        let playerClass = rosterName ? "boardPlayer" : "boardPlayer muted";

        if (s.isForfeit){
          const extra = rosterName ? ` <span class="smallMuted">(coach kid: ${escapeHtml(rosterName)})</span>` : "";
          playerText = `FORFEIT${extra}`;
          playerClass = "boardPlayer";
        }

        const row = document.createElement("div");
        row.className = "boardRow" + (isClock ? " onclock" : "") + (s.isForfeit ? " forfeit" : "");
        if (isClock){
          // More aggressive highlight using the team's color (fallback to neutral if missing).
          const tc = c || "rgba(0,0,0,.55)";
          row.style.borderColor = tc;
          row.style.borderWidth = "2px";
          row.style.boxShadow = `0 0 0 5px ${colorToRgba(tc, 0.18)}, 0 12px 28px rgba(0,0,0,.14)`;
          row.style.background = colorToRgba(tc, 0.06);
        }
        row.innerHTML = `
          <div class="boardLeft">
            <div class="boardPick">R${s.round} • ${String(s.posInRound).padStart(2,"0")}</div>
            <div class="boardTeam" style="${c ? `color:${escapeHtml(c)};` : ""}">${escapeHtml(s.teamName)}</div>
          </div>
          <div class="${playerClass}" title="${escapeHtml(rosterName || "")}">${playerText}</div>
        `;
        wrap.appendChild(row);
      }

      el.appendChild(roundCard);
    }
  }

  function applyFilters(players){
    const q = norm(document.getElementById("q").value);
    const travel = norm(document.getElementById("travelFilter").value);
    const level = norm(document.getElementById("levelFilter").value);
    const pitcher = norm(document.getElementById("pitcherFilter").value);
    const school = norm(document.getElementById("schoolFilter").value);

    const sp = norm(document.getElementById("springPitchingFilter").value);
    const sh = norm(document.getElementById("springHittingFilter").value);
    const st = norm(document.getElementById("springThrowingFilter").value);
    const sf = norm(document.getElementById("springFieldingFilter").value);

    return players.filter(p => {
      const name = norm(p.Name);
      if (q && !name.includes(q)) return false;

      const tr = norm(p.Travel);
      if (travel === "y" && tr !== "y") return false;
      if (travel === "n" && tr === "y") return false;

      const lv = norm(p.TravelLevel);
      if (level){
        if (level === "none"){
          if (lv && lv !== "none") return false;
        } else if (lv !== level) return false;
      }

      const pi = norm(p.Pitcher);
      if (pitcher === "y" && pi !== "y") return false;
      if (pitcher === "n" && pi === "y") return false;

      const sc = norm(p.School);
      if (school && sc !== school) return false;

      const _sp = norm(p.SpringPitching);
      if (sp === "y" && _sp !== "y") return false;
      if (sp === "n" && _sp === "y") return false;

      const _sh = norm(p.SpringHitting);
      if (sh === "y" && _sh !== "y") return false;
      if (sh === "n" && _sh === "y") return false;

      const _st = norm(p.SpringThrowing);
      if (st === "y" && _st !== "y") return false;
      if (st === "n" && _st === "y") return false;

      const _sf = norm(p.SpringFielding);
      if (sf === "y" && _sf !== "y") return false;
      if (sf === "n" && _sf === "y") return false;

      return true;
    });
  }

  function openModal(player){
    const bd = document.getElementById("modalBackdrop");
    const title = document.getElementById("modalTitle");
    const tags = document.getElementById("modalTags");
    const kv = document.getElementById("modalKV");
    if (!bd) return;

    title.textContent = safe(player.Name) || "Player";

    const t = [];
    if (norm(player.Pitcher) === "y") t.push("Pitcher");
    if (norm(player.Travel) === "y") t.push((safe(player.TravelLevel).toUpperCase() || "Travel") + " travel");
    if (safe(player.School)) t.push(safe(player.School));
    tags.textContent = t.join(" • ") || "";

    kv.innerHTML = "";
    const grid = document.createElement("div");
    grid.className = "kvGrid";

    for (const col of DETAIL_SCHEMA){
      const colEl = document.createElement("div");
      colEl.className = "kvCol";
      for (const k of col){
        const v = safe(player[k]);
        const row = document.createElement("div");
        row.className = "kvRow";
        row.innerHTML = `
          <div class="k">${escapeHtml(k)}</div>
          <div class="v">${escapeHtml(v || "n/a")}</div>
        `;
        colEl.appendChild(row);
      }
      grid.appendChild(colEl);
    }

    kv.appendChild(grid);

    bd.classList.add("open");
    bd.setAttribute("aria-hidden","false");
  }

  function closeModal(){
    const bd = document.getElementById("modalBackdrop");
    if (!bd) return;
    bd.classList.remove("open");
    bd.setAttribute("aria-hidden","true");
  }

  function setTakenView(view){
    TAKEN_VIEW = view;
    const taken = document.getElementById("taken");
    const board = document.getElementById("draftBoard");
    const a = document.getElementById("viewTakenBtn");
    const b = document.getElementById("viewBoardBtn");
    if (!taken || !board || !a || !b) return;

    const isTeam = view === "team";
    taken.style.display = isTeam ? "grid" : "none";
    board.style.display = isTeam ? "none" : "grid";

    a.classList.toggle("active", isTeam);
    b.classList.toggle("active", !isTeam);
    a.setAttribute("aria-pressed", isTeam ? "true" : "false");
    b.setAttribute("aria-pressed", !isTeam ? "true" : "false");
  }

  async function loadAll(){
    const teamsUrl = window.SHEET?.Teams;
    const rosterUrl = window.SHEET?.Roster;
    const poolUrl = window.SHEET?.DraftPool;

    const [teams, roster, pool] = await Promise.all([
      fetchCsv(teamsUrl),
      fetchCsv(rosterUrl),
      fetchCsv(poolUrl)
    ]);

    TEAMS = teams;
    TEAM_BY_SLUG = new Map();
    TEAM_COLOR_BY_SLUG = new Map();

    for (const t of TEAMS){
      const slug = safe(t.TeamSlug);
      if (!slug) continue;
      TEAM_BY_SLUG.set(slug, t);
      TEAM_COLOR_BY_SLUG.set(slug, safe(t.TeamColor));
    }

    // Populate school filter options
    const schools = Array.from(new Set(pool.map(p => safe(p.School)).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
    const schoolSel = document.getElementById("schoolFilter");
    if (schoolSel){
      const cur = safe(schoolSel.value);
      schoolSel.innerHTML = `<option value="">All</option>` + schools.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
      schoolSel.value = cur;
    }

    // Player map and taken structures
    const playerMap = buildPlayerMap(pool);

    // rosterByTeamRound (typed picks)
    const rosterByTeamRound = computeRosterIndex(roster);

    // taken list (for by-team view)
    const takenByTeam = buildTakenByTeam(roster, playerMap);

    // forfeits from coach kids (requires taken players with CoachKid+TravelLevel)
    const forfeitsByTeam = computeForfeitsFromCoachKids(takenByTeam);

    // board slots from teams + forfeits
    const pickSeq = buildPickSequence(TEAMS);
    const boardSlots = buildBoardSlots(TEAMS, forfeitsByTeam);

    // picksMade (counts roster names excluding coach kids in roster rows if flagged)
    const picksMade = calcPicksMade(roster);

    // Compute on-the-clock
    const curPick = pickSeq[picksMade];
    const otcTeamEl = document.getElementById("otcTeam");
    const otcMetaEl = document.getElementById("otcMeta");
    const pickPill = document.getElementById("pickPill");
    const roundPill = document.getElementById("roundPill");
    const otcCard = document.getElementById("otcCard");

    if (curPick){
      const tcol = teamColor(curPick.teamSlug);
      otcTeamEl.textContent = curPick.teamName;
      otcTeamEl.style.color = tcol || "";
      otcMetaEl.textContent = `Round ${curPick.round} • Pick ${picksMade+1} of ${TOTAL_TEAMS*TOTAL_ROUNDS}`;
      pickPill.textContent = `Pick ${picksMade+1}`;
      roundPill.textContent = `Round ${curPick.round}`;

      if (otcCard){
        // wash background lightly with team color by applying alpha
        const wash = tcol ? colorToRgba(tcol, 0.10) : "rgba(0,0,0,.02)";
        otcCard.style.background = wash;
      }
    } else {
      otcTeamEl.textContent = "Draft complete";
      otcMetaEl.textContent = `${TOTAL_TEAMS*TOTAL_ROUNDS} picks completed`;
      pickPill.textContent = `Pick —`;
      roundPill.textContent = `Round —`;
      if (otcCard) otcCard.style.background = "rgba(0,0,0,.02)";
    }

    // Last 5 picks ticker from roster order by pick sequence
    // Build list of last picks by iterating pickSeq and pulling rosterByTeamRound
    const picked = [];
    for (let i = 0; i < pickSeq.length; i++){
      const s = pickSeq[i];
      const nm = rosterByTeamRound.get(`${s.teamSlug}|${s.round}`);
      if (nm){
        picked.push({ teamSlug: s.teamSlug, teamName: s.teamName, playerName: nm, round: s.round });
      } else if ((forfeitsByTeam.get(s.teamSlug) || new Set()).has(s.round)){
        // forfeit doesn't add to ticker unless name exists
      }
    }
    const last5 = picked.slice(-5).reverse();
    renderTicker(last5);

    // Available list: remove taken names
    const takenNames = new Set(roster.map(r => norm(r.PlayerName || r.Name)).filter(Boolean));
    const avail = pool.filter(p => {
      const nm = norm(p.Name);
      return nm && !takenNames.has(nm);
    });

    // Apply filters
    const filtered = applyFilters(avail);
    renderAvailable(filtered);

    // Render taken views
    renderTakenByTeam(takenByTeam, forfeitsByTeam);
    renderDraftBoard(boardSlots, rosterByTeamRound, forfeitsByTeam, playerMap, pickSeq, picksMade);
  }

  function attachEvents(){
    // Filters update available list live
    const ids = [
      "q","pitcherFilter","travelFilter","levelFilter","schoolFilter",
      "springPitchingFilter","springHittingFilter","springThrowingFilter","springFieldingFilter",
      "takenTeamFilter"
    ];
    for (const id of ids){
      const el = document.getElementById(id);
      if (!el) continue;
      el.addEventListener("input", () => loadAll().catch(console.error));
      el.addEventListener("change", () => loadAll().catch(console.error));
    }

    document.getElementById("refreshBtn")?.addEventListener("click", () => loadAll().catch(console.error));
    document.getElementById("clearBtn")?.addEventListener("click", () => {
      document.getElementById("q").value = "";
      document.getElementById("pitcherFilter").value = "";
      document.getElementById("travelFilter").value = "";
      document.getElementById("levelFilter").value = "";
      document.getElementById("schoolFilter").value = "";
      document.getElementById("takenTeamFilter").value = "";
      document.getElementById("springPitchingFilter").value = "";
      document.getElementById("springHittingFilter").value = "";
      document.getElementById("springThrowingFilter").value = "";
      document.getElementById("springFieldingFilter").value = "";
      loadAll().catch(console.error);
    });

    document.getElementById("modalBackdrop")?.addEventListener("click", (e) => {
      if (e.target?.id === "modalBackdrop") closeModal();
    });
    document.getElementById("modalClose")?.addEventListener("click", closeModal);

    document.getElementById("viewTakenBtn")?.addEventListener("click", () => setTakenView("team"));
    document.getElementById("viewBoardBtn")?.addEventListener("click", () => setTakenView("board"));

    // Auto refresh
    setInterval(() => loadAll().catch(console.error), 8000);
  }

  // Init
  attachEvents();
  setTakenView("team");
  loadAll().catch(err => {
    console.error(err);
    document.getElementById("availMsg").textContent = "Failed to load data. Check data.js URLs.";
    document.getElementById("takenMsg").textContent = "Failed to load data. Check data.js URLs.";
  });
</script>
</body>
</html>
