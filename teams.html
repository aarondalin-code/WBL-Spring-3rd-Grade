<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teams • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026" />
</head>

<body class="watermarkPage teamsPage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button
      class="navToggle"
      type="button"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="siteNav"
    >
      <span></span><span></span><span></span>
    </button>

    <div class="navOverlay" aria-hidden="true"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <!-- Add Playoffs later when we build playoffs.html -->
      <a href="./teams.html" class="active">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Teams</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">
    <h2>Teams</h2>
    <p class="muted">Tap a team to view its roster.</p>

    <div class="card">
      <div class="cardBody">
        <div id="teamsGrid" class="teamsGrid"></div>

        <p class="muted small" style="margin-top:12px;">
          This page pulls team info from your Google Sheet “Teams” CSV.
        </p>
      </div>
    </div>
  </section>
</main>

<script src="./data.js"></script>

<script>
  // -----------------------------
  // Helpers
  // -----------------------------
  function safe(v){ return String(v ?? "").trim(); }

  async function fetchCsv(url) {
    if (!url) throw new Error("Missing TEAMS_CSV_URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to fetch teams CSV");
    return await res.text();
  }

  // Robust CSV parser (quoted commas safe)
  function parseCsv(text) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g, ""));
    return rows
      .filter(r => r.some(x => safe(x) !== ""))
      .map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = safe(r[idx]));
        return obj;
      });
  }

  function numOrNull(x){
    const n = Number(safe(x));
    return Number.isFinite(n) ? n : null;
  }

  function renderTeams(teamRows) {
    const grid = document.getElementById("teamsGrid");
    grid.innerHTML = "";

    // Schema B columns expected:
    // Seed (optional), TeamName, TeamSlug, TeamLogo
    const teams = teamRows
      .map(r => ({
        seed: numOrNull(r.Seed),                // optional
        name: safe(r.TeamName),
        slug: safe(r.TeamSlug),
        logo: safe(r.TeamLogo),
      }))
      .filter(t => t.name && t.slug);

    // Sort: Seed if present; otherwise alphabetical
    const hasAnySeed = teams.some(t => t.seed !== null);
    teams.sort((a, b) => {
      if (hasAnySeed) {
        const as = a.seed ?? 9999;
        const bs = b.seed ?? 9999;
        if (as !== bs) return as - bs;
      }
      return a.name.localeCompare(b.name);
    });

    for (const t of teams) {
      const logoUrl = t.logo || (window.DEFAULT_TEAM_LOGO || "./logo.png");

      const a = document.createElement("a");
      a.className = "teamTile";
      a.href = `./team.html?team=${encodeURIComponent(t.slug)}`;

      a.innerHTML = `
        <span class="teamAccent" aria-hidden="true"></span>

        <div class="teamTileRow">
          <div class="teamTileLogoWrap">
            <img class="teamTileLogo" src="${logoUrl}" alt="${t.name} logo"
                 onerror="this.onerror=null; this.src='./logo.png';">
          </div>

          <div class="teamTileText">
            <div class="teamName">${t.name}</div>
            <div class="teamCta">View roster →</div>
          </div>
        </div>
      `;

      grid.appendChild(a);
    }

    // Helpful empty state
    if (!teams.length) {
      grid.innerHTML = `<p class="muted">No teams found. Check your Teams CSV headers (TeamName, TeamSlug, TeamLogo).</p>`;
    }
  }

  (async function init(){
    try {
      const csv = await fetchCsv(window.SHEET?.TEAMS_CSV_URL);
      const rows = parseCsv(csv);
      renderTeams(rows);
    } catch (err) {
      console.error(err);
      alert("Teams page error: check TEAMS_CSV_URL in data.js and make sure the Teams tab is published to CSV.");
    }
  })();
</script>

<script src="./nav.js"></script>
</body>
</html>
