<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026" />
</head>

<body class="watermarkPage galleryPage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="siteNav">
      <span></span><span></span><span></span>
    </button>

    <div class="navOverlay" aria-hidden="true"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./teams.html">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html" class="active">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Gallery</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">
    <h2>Photos & Videos</h2>
    <p class="muted">Highlights from the season. New content posted weekly.</p>

    <div class="card" style="margin-top:12px;">
      <div class="cardBody">
        <div class="galleryMetaRow">
          <div class="muted small" id="resultCount"></div>
        </div>
      </div>
    </div>

    <div id="galleryGrid" class="galleryGrid"></div>
    <p id="galleryMsg" class="muted small" style="margin-top:12px;"></p>
  </section>
</main>

<script src="./data.js"></script>
<script>
  const grid = document.getElementById("galleryGrid");
  const msgEl = document.getElementById("galleryMsg");
  const countEl = document.getElementById("resultCount");

  function safe(v){ return String(v ?? "").trim(); }

  async function fetchCsv(url) {
    if (!url) throw new Error("Missing GALLERY_CSV_URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to load gallery CSV (${res.status})`);
    return await res.text();
  }

  // Robust CSV parser (quoted commas safe) + BOM strip
  function parseCsv(text) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map((h) => {
      let key = safe(h).replace(/\s+/g,"");
      key = key.replace(/^\uFEFF/, "");
      return key;
    });

    return rows.map(r => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = safe(r[idx]));
      return obj;
    });
  }

  function normalizeType(t){
    t = safe(t).toLowerCase();
    if (t === "photo" || t === "image") return "photo";
    if (t === "video") return "video";
    return "";
  }

  function isImageUrl(url){
    const u = safe(url).toLowerCase();
    return u.match(/\.(jpg|jpeg|png|gif|webp)(\?|#|$)/);
  }

  function youtubeEmbed(url){
    const u = safe(url);
    let m = u.match(/youtu\.be\/([^?&]+)/);
    if (m) return `https://www.youtube.com/embed/${m[1]}`;
    m = u.match(/[?&]v=([^?&]+)/);
    if (m) return `https://www.youtube.com/embed/${m[1]}`;
    m = u.match(/youtube\.com\/shorts\/([^?&]+)/);
    if (m) return `https://www.youtube.com/embed/${m[1]}`;
    return "";
  }

  function buildCaption(it){
    const parts = [];

    const title = safe(it.Title);
    if (title) parts.push(title);

    const team = safe(it.Team);
    const player = safe(it.Player);
    if (team && player) parts.push(`${team} • ${player}`);
    else if (team) parts.push(team);
    else if (player) parts.push(player);

    const credit = safe(it.Credit);
    if (credit) parts.push(`Credit: ${credit}`);

    return parts.join(" — ");
  }

  function render(items){
    grid.innerHTML = "";

    if (!items.length) {
      countEl.textContent = "";
      msgEl.textContent = "No gallery items yet.";
      return;
    }

    countEl.textContent = `${items.length} item(s)`;

    const html = items.map(it => {
      const url = safe(it.MediaURL);
      if (!url) return "";

      const type = normalizeType(it.Type) || (isImageUrl(url) ? "photo" : "");
      const caption = buildCaption(it);

      if (type === "video") {
        const yt = youtubeEmbed(url);
        if (yt) {
          return `
            <div class="galleryItem">
              <div class="galleryMedia">
                <iframe src="${yt}" title="${caption}" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen></iframe>
              </div>
              ${caption ? `<div class="galleryCaption">${caption}</div>` : ""}
            </div>
          `;
        }
        return `
          <div class="galleryItem">
            <div class="galleryMedia" style="display:flex; align-items:center; justify-content:center; padding:18px;">
              <a href="${url}" target="_blank" rel="noopener">Open video</a>
            </div>
            ${caption ? `<div class="galleryCaption">${caption}</div>` : ""}
          </div>
        `;
      }

      return `
        <div class="galleryItem">
          <div class="galleryMedia">
            <a href="${url}" target="_blank" rel="noopener">
              <img src="${url}" alt="${caption}" loading="lazy" />
            </a>
          </div>
          ${caption ? `<div class="galleryCaption">${caption}</div>` : ""}
        </div>
      `;
    }).join("");

    grid.innerHTML = html;
    msgEl.textContent = "";
  }

  async function init(){
    msgEl.textContent = "";
    countEl.textContent = "";

    const csv = await fetchCsv(window.SHEET?.GALLERY_CSV_URL);
    const rows = parseCsv(csv);

    const items = rows.filter(r => safe(r.MediaURL));
    render(items);
  }

  init().catch(err => {
    console.error(err);
    msgEl.textContent = "Gallery error: " + err.message;
  });
</script>

<script src="./nav.js"></script>
</body>
</html>


