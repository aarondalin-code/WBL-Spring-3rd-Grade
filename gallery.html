<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026-gallery-drivefix-1" />
</head>

<body class="watermarkPage galleryPage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="siteNav">
      <span></span><span></span><span></span>
    </button>

    <div class="navOverlay" aria-hidden="true"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./teams.html">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html" class="active">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Gallery</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">
    <h2>Photos & Videos</h2>
    <p class="muted">Highlights from the season. New content posted weekly.</p>

    <div class="card" style="margin-top:12px;">
      <div class="cardBody">

        <!-- Filters (styled like schedule page) -->
        <div class="scheduleFilters" style="margin-bottom:12px;">
          <select id="teamFilter">
            <option value="">All Teams</option>
          </select>

          <select id="typeFilter">
            <option value="">All Types</option>
            <option value="photo">Photos</option>
            <option value="video">Videos</option>
          </select>

          <button id="clearFilters" class="btnSecondary" type="button">Clear</button>
        </div>

        <div class="galleryMetaRow">
          <div class="muted small" id="resultCount"></div>
        </div>
      </div>
    </div>

    <div id="galleryGrid" class="galleryGrid"></div>
    <p id="galleryMsg" class="muted small" style="margin-top:12px;"></p>
  </section>
</main>

<script src="./data.js"></script>
<script>
  const grid = document.getElementById("galleryGrid");
  const msgEl = document.getElementById("galleryMsg");
  const countEl = document.getElementById("resultCount");

  const teamFilter = document.getElementById("teamFilter");
  const typeFilter = document.getElementById("typeFilter");
  const clearBtn = document.getElementById("clearFilters");

  let allItems = [];

  function safe(v){ return String(v ?? "").trim(); }
  function norm(v){ return safe(v).toLowerCase(); }

  async function fetchCsv(url) {
    if (!url) throw new Error("Missing GALLERY_CSV_URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to load gallery CSV (${res.status})`);
    return await res.text();
  }

  // Robust CSV parser (quoted commas safe) + BOM strip
  function parseCsv(text) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map((h) => {
      let key = safe(h).replace(/\s+/g,"");
      key = key.replace(/^\uFEFF/, "");
      return key;
    });

    return rows.map(r => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = safe(r[idx]));
      return obj;
    });
  }

  // ---- URL + type helpers ----
  function isImageUrl(url){
    const u = safe(url).toLowerCase();
    return u.match(/\.(jpg|jpeg|png|gif|webp)(\?|#|$)/);
  }

  function youtubeEmbed(url){
    const u = safe(url);
    let m = u.match(/youtu\.be\/([^?&]+)/);
    if (m) return `https://www.youtube.com/embed/${m[1]}`;
    m = u.match(/[?&]v=([^?&]+)/);
    if (m) return `https://www.youtube.com/embed/${m[1]}`;
    m = u.match(/youtube\.com\/shorts\/([^?&]+)/);
    if (m) return `https://www.youtube.com/embed/${m[1]}`;
    return "";
  }

  // Convert Drive links to direct-display image link
  function driveToDirect(url){
    url = safe(url);
    if (!url) return "";

    // open?id=FILEID
    let m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    // file/d/FILEID/view
    m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
    if (m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    // uc?id=FILEID already
    m = url.match(/drive\.google\.com\/uc\?[^#]*id=([a-zA-Z0-9_-]+)/);
    if (m) return `https://drive.google.com/uc?export=view&id=${m[1]}`;

    return url;
  }

  function normalizeTypeFromForm(mediaType, url){
    const t = norm(mediaType);
    if (t.includes("video")) return "video";
    if (t.includes("photo") || t.includes("image") || t.includes("picture")) return "photo";

    // Fallback inference
    if (youtubeEmbed(url)) return "video";
    if (isImageUrl(url)) return "photo";
    // Drive links often are photos; default to photo if not sure
    if (url.includes("drive.google.com")) return "photo";
    return "";
  }

  // Prefer Media Link; fallback to File Upload
  function pickMediaUrl(row){
    const link = safe(row.MediaLink);     // "Media Link"
    const upload = safe(row.FileUpload);  // "File Upload"

    if (link) return link;

    if (upload){
      const first = upload.split(/\s*,\s*/)[0]; // in case multiple
      return first;
    }

    return "";
  }

  // Permission column is: "I confirm I have permission."
  // Header key becomes: "IconfirmIhavepermission."
  function hasPermission(row){
    const v = norm(row["IconfirmIhavepermission."]);
    if (!v) return true; // allow if blank
    return (v === "yes" || v === "y" || v === "true" || v.includes("confirm"));
  }

  function buildCaptionFromForm(it){
    const parts = [];

    const cap = safe(it.Caption);
    if (cap) parts.push(cap);

    const team = safe(it.Team);
    const name = safe(it.Name);
    if (team && name) parts.push(`${team} • ${name}`);
    else if (team) parts.push(team);
    else if (name) parts.push(name);

    return parts.join(" — ");
  }

  function populateTeamFilter(items){
    const set = new Set();
    items.forEach(it => { if (safe(it.Team)) set.add(safe(it.Team)); });

    while (teamFilter.options.length > 1) teamFilter.remove(1);

    [...set].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      teamFilter.appendChild(opt);
    });
  }

  function matchesFilters(it){
    if (teamFilter.value && norm(it.Team) !== norm(teamFilter.value)) return false;
    if (typeFilter.value && norm(it._type) !== norm(typeFilter.value)) return false;
    return true;
  }

  function render(items){
    grid.innerHTML = "";

    if (!items.length) {
      countEl.textContent = "";
      msgEl.textContent = "No gallery items match your filters.";
      return;
    }

    countEl.textContent = `${items.length} item(s)`;
    msgEl.textContent = "";

    const html = items.map(it => {
      const url = safe(it._url);
      if (!url) return "";

      const type = it._type;
      const caption = buildCaptionFromForm(it);

      if (type === "video") {
        const yt = youtubeEmbed(url);
        if (yt) {
          return `
            <div class="galleryItem">
              <div class="galleryMedia">
                <iframe src="${yt}" title="${caption}" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen></iframe>
              </div>
              ${caption ? `<div class="galleryCaption">${caption}</div>` : ""}
            </div>
          `;
        }
        return `
          <div class="galleryItem">
            <div class="galleryMedia" style="display:flex; align-items:center; justify-content:center; padding:18px;">
              <a href="${url}" target="_blank" rel="noopener">Open video</a>
            </div>
            ${caption ? `<div class="galleryCaption">${caption}</div>` : ""}
          </div>
        `;
      }

      return `
        <div class="galleryItem">
          <div class="galleryMedia">
            <a href="${url}" target="_blank" rel="noopener">
              <img src="${url}" alt="${caption}" loading="lazy"
                   onerror="this.onerror=null; this.src='./logo.png';" />
            </a>
          </div>
          ${caption ? `<div class="galleryCaption">${caption}</div>` : ""}
        </div>
      `;
    }).join("");

    grid.innerHTML = html;
  }

  async function init(){
    msgEl.textContent = "";
    countEl.textContent = "";

    const csv = await fetchCsv(window.SHEET?.GALLERY_CSV_URL);
    const rows = parseCsv(csv);

    // Form response headers become (spaces removed):
    // Timestamp, Team, Name, MediaType, FileUpload, MediaLink, Caption, IconfirmIhavepermission.
    allItems = rows
      .filter(r => hasPermission(r))
      .map(r => {
        const rawUrl = pickMediaUrl(r);
        const cookedUrl = driveToDirect(rawUrl);

        const t = normalizeTypeFromForm(r.MediaType, cookedUrl) ||
                  (youtubeEmbed(cookedUrl) ? "video" : (isImageUrl(cookedUrl) ? "photo" : "photo"));

        return {
          Timestamp: safe(r.Timestamp),
          Team: safe(r.Team),
          Name: safe(r.Name),
          MediaType: safe(r.MediaType),
          FileUpload: safe(r.FileUpload),
          MediaLink: safe(r.MediaLink),
          Caption: safe(r.Caption),
          _url: cookedUrl,
          _type: t
        };
      })
      .filter(it => safe(it._url));

    populateTeamFilter(allItems);

    function apply(){
      const filtered = allItems.filter(matchesFilters);
      render(filtered);
    }

    teamFilter.addEventListener("change", apply);
    typeFilter.addEventListener("change", apply);
    clearBtn.addEventListener("click", ()=>{
      teamFilter.value = "";
      typeFilter.value = "";
      apply();
    });

    apply();
  }

  init().catch(err => {
    console.error(err);
    msgEl.textContent = "Gallery error: " + err.message;
  });
</script>

<script src="./nav.js"></script>
</body>
</html>

