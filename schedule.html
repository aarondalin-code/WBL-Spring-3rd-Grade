<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule/Scores • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026-schedule4" />
</head>

<body class="watermarkPage schedulePage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button">
      <span></span><span></span><span></span>
    </button>
    <div class="navOverlay"></div>

    <nav class="nav">
      <a href="./">Home</a>
      <a href="./schedule.html" class="active">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Schedule / Scores</div>
  </div>
</header>

<main class="wrap">
<section class="docSection">

<div class="card">
  <div class="cardBody">

    <!-- Filters -->
    <div class="scheduleFilters">
      <select id="teamFilter">
        <option value="">All Teams</option>
      </select>

      <select id="dateFilter">
        <option value="">All Dates</option>
      </select>

      <button id="clearFilters" class="btnSecondary">Clear</button>
    </div>

    <div id="scheduleContainer"></div>

    <p id="scheduleMsg" class="muted small" style="margin-top:12px;"></p>
  </div>
</div>

</section>
</main>

<script src="./data.js"></script>

<script>
  const container = document.getElementById("scheduleContainer");
  const msgEl = document.getElementById("scheduleMsg");
  const teamFilter = document.getElementById("teamFilter");
  const dateFilter = document.getElementById("dateFilter");
  const clearBtn = document.getElementById("clearFilters");

  let allGames = [];
  // teamMeta: key = normalized TeamName, value = { slug, logo, color }
  const teamMeta = new Map();

  function safe(v){ return String(v ?? "").trim(); }
  function norm(v){ return safe(v).toLowerCase(); }
  function isFinal(status){ return norm(status) === "final"; }

  async function fetchCsv(url){
    if (!url) throw new Error("Missing CSV URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache:"no-store" });
    if (!res.ok) throw new Error("Failed to fetch CSV");
    return await res.text();
  }

  function parseCsv(text){
    const rows=[], row=[];
    let cur="", inQuotes=false, r=[];

    for(let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if(ch === '"'){
        if(inQuotes && next === '"'){ cur+='"'; i++; }
        else inQuotes=!inQuotes;
        continue;
      }
      if(!inQuotes && ch === ","){ r.push(cur); cur=""; continue; }
      if(!inQuotes && (ch === "\n" || ch === "\r")){
        if(ch === "\r" && next === "\n") i++;
        r.push(cur); cur="";
        if(r.some(v=>safe(v)!=="")) rows.push(r);
        r=[];
        continue;
      }
      cur += ch;
    }
    r.push(cur);
    if(r.some(v=>safe(v)!=="")) rows.push(r);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g,""));
    return rows.map(arr => {
      const o={};
      headers.forEach((h,idx)=> o[h]=safe(arr[idx]));
      return o;
    }).filter(o => Object.values(o).some(v => safe(v) !== ""));
  }

  function sortGames(a,b){
    return safe(a.Date).localeCompare(safe(b.Date)) ||
           safe(a.Time).localeCompare(safe(b.Time)) ||
           safe(a.Field).localeCompare(safe(b.Field));
  }

  function groupByDate(games){
    const m = new Map();
    for (const g of games){
      const d = safe(g.Date) || "TBD";
      if(!m.has(d)) m.set(d, []);
      m.get(d).push(g);
    }
    return m;
  }

  function getMeta(teamName){
    const m = teamMeta.get(norm(teamName));
    return m || {
      slug: "",
      logo: window.DEFAULT_TEAM_LOGO || "./logo.png",
      color: ""
    };
  }

  function teamAnchor(teamName){
    const m = getMeta(teamName);
    const href = m.slug ? `./team.html?team=${encodeURIComponent(m.slug)}` : "#";
    const style = m.color ? `style="color:${m.color}"` : "";
    return `<a class="scheduleTeamLink" ${style} href="${href}">${safe(teamName) || "TBD"}</a>`;
  }

  function render(){
    container.innerHTML = "";

    let filtered = [...allGames];

    if (teamFilter.value){
      filtered = filtered.filter(g =>
        norm(g.TeamA) === norm(teamFilter.value) ||
        norm(g.TeamB) === norm(teamFilter.value)
      );
    }

    if (dateFilter.value){
      filtered = filtered.filter(g => safe(g.Date) === dateFilter.value);
    }

    filtered.sort(sortGames);

    const grouped = groupByDate(filtered);

    for (const [date, games] of grouped){
      const section = document.createElement("div");
      section.className = "scheduleDateSection";

      section.innerHTML = `<div class="scheduleDateHeader">${date}</div>`;

      for (const g of games){
        const a = safe(g.TeamA);
        const b = safe(g.TeamB);
        const aMeta = getMeta(a);
        const bMeta = getMeta(b);

        const final = isFinal(g.Status);
        const score = (final && safe(g.ScoreA) && safe(g.ScoreB)) ? `${safe(g.ScoreA)}–${safe(g.ScoreB)}` : "";

        const card = document.createElement("div");
        card.className = "scheduleGameCard";
        if(final) card.classList.add("finalGame");

        card.innerHTML = `
          <div class="scheduleGameMeta">
            <div class="metaTop">${safe(g.Time) || ""}</div>
            <div class="metaBottom">${safe(g.Field) || ""}</div>
          </div>

          <div class="scheduleMatchupGrid">
            <div class="scheduleTeam sideLeft">
              <span class="teamText">${teamAnchor(a)}</span>
              <img class="teamLogo" src="${aMeta.logo}" alt="${a} logo"
                   onerror="this.onerror=null; this.src='${window.DEFAULT_TEAM_LOGO || "./logo.png"}';">
            </div>

            <div class="scheduleScore">
              ${score || `<span class="vsLabel">vs</span>`}
            </div>

            <div class="scheduleTeam sideRight">
              <img class="teamLogo" src="${bMeta.logo}" alt="${b} logo"
                   onerror="this.onerror=null; this.src='${window.DEFAULT_TEAM_LOGO || "./logo.png"}';">
              <span class="teamText">${teamAnchor(b)}</span>
            </div>
          </div>

          <div class="scheduleStatus">
            ${final ? `<span class="pillFinal">Final</span>` : (safe(g.Status) || "Scheduled")}
          </div>
        `;

        section.appendChild(card);
      }

      container.appendChild(section);
    }

    msgEl.textContent = filtered.length ? "" : "No games match selected filters.";
  }

  async function init(){
    // Load teams first (for logo + color)
    const teamsCsv = await fetchCsv(window.SHEET?.TEAMS_CSV_URL);
    const teamRows = parseCsv(teamsCsv);

    // Expect: TeamName, TeamSlug, TeamLogo, (optional) TeamColor
    for (const r of teamRows){
      const name = safe(r.TeamName);
      if(!name) continue;

      teamMeta.set(norm(name), {
        slug: safe(r.TeamSlug),
        logo: safe(r.TeamLogo) || (window.DEFAULT_TEAM_LOGO || "./logo.png"),
        color: safe(r.TeamColor) // optional hex like #DF4601
      });
    }

    // Load games
    const gamesCsv = await fetchCsv(window.SHEET?.GAMES_CSV_URL);
    allGames = parseCsv(gamesCsv);

    // Populate Team filter from *teams sheet* (canonical list)
    const teamNames = teamRows.map(r => safe(r.TeamName)).filter(Boolean).sort();
    teamNames.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      teamFilter.appendChild(opt);
    });

    // Populate Date filter from games
    const dateSet = new Set(allGames.map(g => safe(g.Date)).filter(Boolean));
    [...dateSet].sort().forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      dateFilter.appendChild(opt);
    });

    teamFilter.addEventListener("change", render);
    dateFilter.addEventListener("change", render);
    clearBtn.addEventListener("click", () => {
      teamFilter.value = "";
      dateFilter.value = "";
      render();
    });

    render();
  }

  init().catch(err => {
    console.error(err);
    msgEl.textContent = "Schedule error: " + err.message;
  });
</script>

<script src="./nav.js"></script>
</body>
</html>
