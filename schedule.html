<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule/Scores â€¢ WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026-schedule3" />
</head>

<body class="watermarkPage schedulePage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button">
      <span></span><span></span><span></span>
    </button>
    <div class="navOverlay"></div>

    <nav class="nav">
      <a href="./">Home</a>
      <a href="./schedule.html" class="active">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Schedule / Scores</div>
  </div>
</header>

<main class="wrap">
<section class="docSection">

<div class="card">
<div class="cardBody">

<!-- Filters -->
<div class="scheduleFilters">
  <select id="teamFilter">
    <option value="">All Teams</option>
  </select>

  <select id="dateFilter">
    <option value="">All Dates</option>
  </select>

  <button id="clearFilters" class="btnSecondary">Clear</button>
</div>

<div id="scheduleContainer"></div>

<p id="scheduleMsg" class="muted small" style="margin-top:12px;"></p>

</div>
</div>

</section>
</main>

<script src="./data.js"></script>

<script>
const container = document.getElementById("scheduleContainer");
const msgEl = document.getElementById("scheduleMsg");
const teamFilter = document.getElementById("teamFilter");
const dateFilter = document.getElementById("dateFilter");
const clearBtn = document.getElementById("clearFilters");

let allGames = [];
let teamMap = new Map();

function safe(v){ return String(v ?? "").trim(); }
function isFinal(status){ return safe(status).toLowerCase() === "final"; }
function normalize(s){ return safe(s).toLowerCase(); }

async function fetchCsv(url){
  const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
  const res = await fetch(url + bust, {cache:"no-store"});
  return await res.text();
}

function parseCsv(text){
  const rows=[];
  let row=[],cur="",inQuotes=false;

  for(let i=0;i<text.length;i++){
    const ch=text[i],next=text[i+1];
    if(ch==='"'){
      if(inQuotes&&next==='"'){cur+='"';i++;}
      else inQuotes=!inQuotes;
      continue;
    }
    if(!inQuotes&&ch===","){row.push(cur);cur="";continue;}
    if(!inQuotes&&(ch==="\n"||ch==="\r")){
      if(ch==="\r"&&next==="\n")i++;
      row.push(cur);cur="";
      if(row.some(v=>safe(v)!==""))rows.push(row);
      row=[];
      continue;
    }
    cur+=ch;
  }
  row.push(cur);
  if(row.some(v=>safe(v)!==""))rows.push(row);

  const headers=(rows.shift()||[]).map(h=>safe(h).replace(/\s+/g,""));
  return rows.map(r=>{
    const o={};
    headers.forEach((h,i)=>o[h]=safe(r[i]));
    return o;
  });
}

function sortGames(a,b){
  return safe(a.Date).localeCompare(safe(b.Date)) ||
         safe(a.Time).localeCompare(safe(b.Time));
}

function groupByDate(games){
  const map=new Map();
  games.forEach(g=>{
    const d=safe(g.Date);
    if(!map.has(d))map.set(d,[]);
    map.get(d).push(g);
  });
  return map;
}

function teamLink(name){
  const slug = teamMap.get(normalize(name));
  return `<a class="scheduleTeamLink" href="./team.html?team=${slug}">${name}</a>`;
}

function teamLogo(name){
  const slug = teamMap.get(normalize(name));
  const teamInfo = window.TEAM_INFO?.[slug];
  return teamInfo?.logo || window.DEFAULT_TEAM_LOGO || "./logo.png";
}

function render(){
  container.innerHTML="";

  let filtered=[...allGames];

  if(teamFilter.value){
    filtered=filtered.filter(g =>
      normalize(g.TeamA)===normalize(teamFilter.value) ||
      normalize(g.TeamB)===normalize(teamFilter.value)
    );
  }

  if(dateFilter.value){
    filtered=filtered.filter(g=>safe(g.Date)===dateFilter.value);
  }

  filtered.sort(sortGames);

  const grouped=groupByDate(filtered);

  for(const [date,games] of grouped){
    const section=document.createElement("div");
    section.className="scheduleDateSection";

    section.innerHTML=`<div class="scheduleDateHeader">${date}</div>`;

    games.forEach(g=>{
      const final=isFinal(g.Status);
      const score=final?`${g.ScoreA}-${g.ScoreB}`:"";

      const gameDiv=document.createElement("div");
      gameDiv.className="scheduleGameCard";
      if(final) gameDiv.classList.add("finalGame");

      gameDiv.innerHTML=`
        <div class="scheduleGameMeta">
          <div>${g.Time}</div>
          <div>${g.Field}</div>
        </div>

        <div class="scheduleMatchup">
          <div class="scheduleTeam">
            <img src="${teamLogo(g.TeamA)}">
            ${teamLink(g.TeamA)}
          </div>

          <div class="scheduleScore">
            ${score || "vs"}
          </div>

          <div class="scheduleTeam">
            <img src="${teamLogo(g.TeamB)}">
            ${teamLink(g.TeamB)}
          </div>
        </div>

        <div class="scheduleStatus">
          ${final ? "Final" : (g.Status || "Scheduled")}
        </div>
      `;

      section.appendChild(gameDiv);
    });

    container.appendChild(section);
  }

  msgEl.textContent = filtered.length ? "" : "No games match selected filters.";
}

async function init(){
  const gamesCsv=await fetchCsv(window.SHEET.GAMES_CSV_URL);
  const teamsCsv=await fetchCsv(window.SHEET.TEAMS_CSV_URL);

  allGames=parseCsv(gamesCsv);
  const teams=parseCsv(teamsCsv);

  teams.forEach(t=>{
    teamMap.set(normalize(t.TeamName), t.TeamSlug);
  });

  /* Filters */
  const teamSet=new Set();
  allGames.forEach(g=>{
    if(g.TeamA) teamSet.add(g.TeamA);
    if(g.TeamB) teamSet.add(g.TeamB);
  });

  [...teamSet].sort().forEach(team=>{
    const opt=document.createElement("option");
    opt.value=team;
    opt.textContent=team;
    teamFilter.appendChild(opt);
  });

  const dateSet=new Set(allGames.map(g=>g.Date));
  [...dateSet].sort().forEach(date=>{
    const opt=document.createElement("option");
    opt.value=date;
    opt.textContent=date;
    dateFilter.appendChild(opt);
  });

  teamFilter.addEventListener("change",render);
  dateFilter.addEventListener("change",render);
  clearBtn.addEventListener("click",()=>{
    teamFilter.value="";
    dateFilter.value="";
    render();
  });

  render();
}

init();
</script>

<script src="./nav.js"></script>
</body>
</html>
