<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule/Scores • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026-schedule-toggle1" />
</head>

<body class="watermarkPage schedulePage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button" aria-label="Open menu">
      <span></span><span></span><span></span>
    </button>
    <div class="navOverlay"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html" class="active">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Schedule / Scores</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">
    <div class="card">
      <div class="cardBody">

        <!-- Filters -->
        <div class="scheduleFilters">
          <select id="teamFilter">
            <option value="">All Teams</option>
          </select>

          <select id="dateFilter">
            <option value="">All Dates</option>
          </select>

          <button id="clearFilters" class="btnSecondary" type="button">Clear</button>
        </div>

        <!-- Toggle -->
        <div class="scheduleToggle" role="tablist" aria-label="Schedule filter">
          <button id="toggleAll" class="toggleBtn active" type="button">All</button>
          <button id="toggleUpcoming" class="toggleBtn" type="button">Upcoming</button>
          <button id="toggleCompleted" class="toggleBtn" type="button">Completed</button>
        </div>

        <!-- Render target -->
        <div id="scheduleContainer"></div>

        <p id="scheduleMsg" class="muted small" style="margin-top:12px;"></p>
      </div>
    </div>
  </section>
</main>

<script src="./data.js"></script>

<script>
  const container = document.getElementById("scheduleContainer");
  const msgEl = document.getElementById("scheduleMsg");

  const teamFilter = document.getElementById("teamFilter");
  const dateFilter = document.getElementById("dateFilter");
  const clearBtn = document.getElementById("clearFilters");

  const toggleAll = document.getElementById("toggleAll");
  const toggleUpcoming = document.getElementById("toggleUpcoming");
  const toggleCompleted = document.getElementById("toggleCompleted");

  let allGames = [];
  let statusMode = "all"; // "all" | "upcoming" | "completed"

  // Teams meta from Teams CSV:
  // key: normalized TeamName -> { slug, logo, color }
  const teamMeta = new Map();

  function safe(v){ return String(v ?? "").trim(); }
  function norm(v){ return safe(v).toLowerCase(); }
  function isFinal(status){ return norm(status) === "final"; }

  async function fetchCsv(url){
    if (!url) throw new Error("Missing CSV URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache:"no-store" });
    if (!res.ok) throw new Error(`Failed to fetch CSV (${res.status})`);
    return await res.text();
  }

  // Robust CSV parser (quoted commas safe)
  function parseCsv(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g,""));
    return rows.map(r => {
      const o = {};
      headers.forEach((h, idx) => o[h] = safe(r[idx]));
      return o;
    }).filter(o => Object.values(o).some(v => safe(v) !== ""));
  }

 function sortGames(a,b){
  // Sort by actual Date object first
  const dateDiff = new Date(a.Date) - new Date(b.Date);
  if (dateDiff !== 0) return dateDiff;

  // Then by time (string compare is fine for 10:00 AM format)
  const timeDiff = safe(a.Time).localeCompare(safe(b.Time));
  if (timeDiff !== 0) return timeDiff;

  // Then by field
  return safe(a.Field).localeCompare(safe(b.Field));
}

  function groupByDate(games){
    const m = new Map();
    for (const g of games){
      const d = safe(g.Date) || "TBD";
      if (!m.has(d)) m.set(d, []);
      m.get(d).push(g);
    }
    return m;
  }

  function getMeta(teamName){
    const m = teamMeta.get(norm(teamName));
    return m || {
      slug: "",
      logo: window.DEFAULT_TEAM_LOGO || "./logo.png",
      color: ""
    };
  }

  function teamAnchor(teamName){
    const name = safe(teamName) || "TBD";
    const m = getMeta(name);

    const href = m.slug ? `./team.html?team=${encodeURIComponent(m.slug)}` : "#";
    const style = m.color ? `style="color:${m.color}"` : "";

    return `<a class="scheduleTeamLink" ${style} href="${href}">${name}</a>`;
  }

  function setActiveToggle(btn){
    [toggleAll, toggleUpcoming, toggleCompleted].forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

  function render(){
    container.innerHTML = "";
    msgEl.textContent = "";

    let filtered = [...allGames];

    // Toggle filter
    if (statusMode === "upcoming") {
      filtered = filtered.filter(g => !isFinal(g.Status));
    } else if (statusMode === "completed") {
      filtered = filtered.filter(g => isFinal(g.Status));
    }

    // Team filter
    if (teamFilter.value) {
      filtered = filtered.filter(g =>
        norm(g.TeamA) === norm(teamFilter.value) ||
        norm(g.TeamB) === norm(teamFilter.value)
      );
    }

    // Date filter
    if (dateFilter.value) {
      filtered = filtered.filter(g => safe(g.Date) === dateFilter.value);
    }

    filtered.sort(sortGames);

    if (!filtered.length) {
      msgEl.textContent = "No games match your filters.";
      return;
    }

    const grouped = groupByDate(filtered);

    for (const [date, games] of grouped){
      const section = document.createElement("div");
      section.className = "scheduleDateSection";
      section.innerHTML = `<div class="scheduleDateHeader">${date}</div>`;

      for (const g of games){
        const aName = safe(g.TeamA);
        const bName = safe(g.TeamB);
        const aMeta = getMeta(aName);
        const bMeta = getMeta(bName);

        const final = isFinal(g.Status);
        const hasScores = safe(g.ScoreA) !== "" && safe(g.ScoreB) !== "";
        const scoreText = (final && hasScores) ? `${safe(g.ScoreA)}–${safe(g.ScoreB)}` : "";

        const card = document.createElement("div");
        card.className = "scheduleGameCard";
        if (final) card.classList.add("finalGame");

        card.innerHTML = `
          <div class="scheduleGameMeta">
            <div>${safe(g.Time) || ""}</div>
            <div>${safe(g.Field) || ""}</div>
          </div>

<div class="scheduleMatchupGrid">
  <div class="scheduleTeam sideLeft">
    ${teamAnchor(aName)}
    <img class="teamLogo" src="${aMeta.logo}" alt="${aName} logo"
         onerror="this.onerror=null; this.src='${window.DEFAULT_TEAM_LOGO || "./logo.png"}';">
  </div>

  <div class="scheduleScore">
    ${scoreText || `<span class="vsLabel">@</span>`}
  </div>

  <div class="scheduleTeam sideRight">
    <img class="teamLogo" src="${bMeta.logo}" alt="${bName} logo"
         onerror="this.onerror=null; this.src='${window.DEFAULT_TEAM_LOGO || "./logo.png"}';">
    ${teamAnchor(bName)}
  </div>
</div>
          <div class="scheduleStatus">
            ${final ? `<span class="pillFinal">Final</span>` : (safe(g.Status) || "Scheduled")}
          </div>
        `;

        section.appendChild(card);
      }

      container.appendChild(section);
    }
  }

  async function init(){
    // Load teams for slug/logo/color
    const teamsCsv = await fetchCsv(window.SHEET?.TEAMS_CSV_URL);
    const teamRows = parseCsv(teamsCsv);

    for (const r of teamRows){
      const name = safe(r.TeamName);
      if (!name) continue;

      teamMeta.set(norm(name), {
        slug: safe(r.TeamSlug),
        logo: safe(r.TeamLogo) || (window.DEFAULT_TEAM_LOGO || "./logo.png"),
        color: safe(r.TeamColor) // optional
      });
    }

    // Load games
    const gamesCsv = await fetchCsv(window.SHEET?.GAMES_CSV_URL);
    allGames = parseCsv(gamesCsv);

    // Populate team filter from Teams tab
    const teamNames = teamRows.map(r => safe(r.TeamName)).filter(Boolean).sort();
    teamNames.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t;
      opt.textContent = t;
      teamFilter.appendChild(opt);
    });

    // Populate date filter from games
    const dateSet = new Set(allGames.map(g => safe(g.Date)).filter(Boolean));
    [...dateSet].sort().forEach(d => {
      const opt = document.createElement("option");
      opt.value = d;
      opt.textContent = d;
      dateFilter.appendChild(opt);
    });

    // Listeners
    teamFilter.addEventListener("change", render);
    dateFilter.addEventListener("change", render);
    clearBtn.addEventListener("click", () => {
      teamFilter.value = "";
      dateFilter.value = "";
      render();
    });

    toggleAll.addEventListener("click", () => {
      statusMode = "all";
      setActiveToggle(toggleAll);
      render();
    });

    toggleUpcoming.addEventListener("click", () => {
      statusMode = "upcoming";
      setActiveToggle(toggleUpcoming);
      render();
    });

    toggleCompleted.addEventListener("click", () => {
      statusMode = "completed";
      setActiveToggle(toggleCompleted);
      render();
    });

    render();
  }

  init().catch(err => {
    console.error(err);
    msgEl.textContent = "Schedule error: " + err.message;
  });
</script>

<script src="./nav.js"></script>
</body>
</html>


