<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule/Scores â€¢ WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026-schedule2" />
</head>

<body class="watermarkPage schedulePage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button class="navToggle" type="button" aria-label="Open menu">
      <span></span><span></span><span></span>
    </button>

    <div class="navOverlay"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html" class="active">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Schedule / Scores</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">

    <div class="card">
      <div class="cardBody">

        <!-- Filters -->
        <div class="scheduleFilters">
          <select id="teamFilter">
            <option value="">All Teams</option>
          </select>

          <select id="dateFilter">
            <option value="">All Dates</option>
          </select>

          <button id="clearFilters" class="btnSecondary">Clear</button>
        </div>

        <div class="tableScroll">
          <table id="scheduleTable" class="scheduleTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Field</th>
                <th>Matchup</th>
                <th class="num">Score</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p id="scheduleMsg" class="muted small" style="margin-top:12px;"></p>

      </div>
    </div>

  </section>
</main>

<script src="./data.js"></script>

<script>
  const tbody = document.querySelector("#scheduleTable tbody");
  const msgEl = document.getElementById("scheduleMsg");

  const teamFilter = document.getElementById("teamFilter");
  const dateFilter = document.getElementById("dateFilter");
  const clearBtn = document.getElementById("clearFilters");

  let allGames = [];

  function safe(v){ return String(v ?? "").trim(); }
  function isFinal(status){ return safe(status).toLowerCase() === "final"; }
  function normalizeKey(s){ return safe(s).toLowerCase(); }

  async function fetchCsv(url) {
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache: "no-store" });
    return await res.text();
  }

  function parseCsv(text) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g,""));
    return rows.map(r => {
      const obj = {};
      headers.forEach((h, idx) => obj[h] = safe(r[idx]));
      return obj;
    });
  }

  function sortGames(a,b){
    return safe(a.Date).localeCompare(safe(b.Date)) ||
           safe(a.Time).localeCompare(safe(b.Time));
  }

  function render(teamNameToSlug){
    tbody.innerHTML = "";

    let filtered = [...allGames];

    if (teamFilter.value) {
      filtered = filtered.filter(g =>
        normalizeKey(g.TeamA) === normalizeKey(teamFilter.value) ||
        normalizeKey(g.TeamB) === normalizeKey(teamFilter.value)
      );
    }

    if (dateFilter.value) {
      filtered = filtered.filter(g => safe(g.Date) === dateFilter.value);
    }

    const sorted = filtered.sort(sortGames);

    for (const g of sorted){
      const final = isFinal(g.Status);
      const score = (final && g.ScoreA && g.ScoreB)
        ? `${g.ScoreA}-${g.ScoreB}`
        : "";

      const tr = document.createElement("tr");
      if (final) tr.classList.add("finalRow");

      tr.innerHTML = `
        <td>${g.Date}</td>
        <td>${g.Time}</td>
        <td>${g.Field}</td>
        <td class="matchupCell">${g.TeamA} <span class="vsSep">vs</span> ${g.TeamB}</td>
        <td class="num">${score}</td>
        <td>${final ? "Final" : (g.Status || "Scheduled")}</td>
      `;

      tbody.appendChild(tr);
    }

    msgEl.textContent = filtered.length
      ? ""
      : "No games match selected filters.";
  }

  async function init(){
    const gamesCsv = await fetchCsv(window.SHEET.GAMES_CSV_URL);
    const teamsCsv = await fetchCsv(window.SHEET.TEAMS_CSV_URL);

    const games = parseCsv(gamesCsv);
    const teams = parseCsv(teamsCsv);

    allGames = games;

    /* Populate Team Filter */
    const teamSet = new Set();
    games.forEach(g => {
      if (g.TeamA) teamSet.add(g.TeamA);
      if (g.TeamB) teamSet.add(g.TeamB);
    });

    [...teamSet].sort().forEach(team => {
      const opt = document.createElement("option");
      opt.value = team;
      opt.textContent = team;
      teamFilter.appendChild(opt);
    });

    /* Populate Date Filter */
    const dateSet = new Set(games.map(g => g.Date).filter(Boolean));
    [...dateSet].sort().forEach(date => {
      const opt = document.createElement("option");
      opt.value = date;
      opt.textContent = date;
      dateFilter.appendChild(opt);
    });

    teamFilter.addEventListener("change", () => render());
    dateFilter.addEventListener("change", () => render());
    clearBtn.addEventListener("click", () => {
      teamFilter.value = "";
      dateFilter.value = "";
      render();
    });

    render();
  }

  init();
</script>

<script src="./nav.js"></script>
</body>
</html>
