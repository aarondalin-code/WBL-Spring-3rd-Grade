<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026" />
</head>

<body class="watermarkPage contactsPage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button
      class="navToggle"
      type="button"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="siteNav"
    >
      <span></span><span></span><span></span>
    </button>

    <div class="navOverlay" aria-hidden="true"></div>

    <nav class="nav" id="siteNav">
      <a href="./">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./teams.html">Teams</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html" class="active">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Contacts</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">
    <h2>Coach Directory</h2>
    <p class="muted">Tap a team to view its roster. Use the links to email or call a coach.</p>

    <div class="card">
      <div class="cardBody">
        <div id="contactsGrid" class="teamsGrid"></div>

        <p class="muted small" style="margin-top:12px;">
          This page pulls team + coach info from your Google Sheet “Teams” CSV.
          Required columns: <strong>TeamName, TeamSlug, TeamLogo, CoachName, CoachEmail, CoachPhone</strong>.
        </p>
        <p id="contactsMsg" class="muted small" style="margin-top:6px;"></p>
      </div>
    </div>
  </section>
</main>

<script src="./data.js"></script>

<script>
  function safe(v){ return String(v ?? "").trim(); }

  async function fetchCsv(url) {
    if (!url) throw new Error("Missing TEAMS_CSV_URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to fetch teams CSV");
    return await res.text();
  }

  // Robust CSV parser (quoted commas safe)
  function parseCsv(text) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map(h => safe(h).replace(/\s+/g, ""));
    return rows
      .filter(r => r.some(x => safe(x) !== ""))
      .map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = safe(r[idx]));
        return obj;
      });
  }

  function mailto(email){
    const e = safe(email);
    return e ? `mailto:${encodeURIComponent(e)}` : "";
  }

  function tel(phone){
    // Make a simple tel link by stripping non-digits (keeps leading +)
    const raw = safe(phone);
    if (!raw) return "";
    const cleaned = raw.replace(/[^\d+]/g, "");
    return cleaned ? `tel:${cleaned}` : "";
  }

  function renderContacts(teamRows) {
    const grid = document.getElementById("contactsGrid");
    const msg = document.getElementById("contactsMsg");
    grid.innerHTML = "";
    msg.textContent = "";

    const teams = teamRows
      .map(r => ({
        name: safe(r.TeamName),
        slug: safe(r.TeamSlug),
        logo: safe(r.TeamLogo),
        coachName: safe(r.CoachName),
        coachEmail: safe(r.CoachEmail),
        coachPhone: safe(r.CoachPhone),
      }))
      .filter(t => t.name && t.slug);

    teams.sort((a,b) => a.name.localeCompare(b.name));

    for (const t of teams) {
      const logoUrl = t.logo || (window.DEFAULT_TEAM_LOGO || "./logo.png");

      const a = document.createElement("a");
      a.className = "teamTile";
      a.href = `./team.html?team=${encodeURIComponent(t.slug)}`;

      const emailHref = mailto(t.coachEmail);
      const phoneHref = tel(t.coachPhone);

      a.innerHTML = `
        <span class="teamAccent" aria-hidden="true"></span>

        <div class="teamTileRow">
          <div class="teamTileLogoWrap">
            <img class="teamTileLogo" src="${logoUrl}" alt="${t.name} logo"
                 onerror="this.onerror=null; this.src='${window.DEFAULT_TEAM_LOGO || "./logo.png"}';">
          </div>

          <div class="teamTileText">
            <div class="teamName">${t.name}</div>

            <div class="muted small" style="margin-top:6px;">
              <strong>Coach:</strong> ${t.coachName || "—"}
            </div>

            <div class="contactLinks" style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
              ${emailHref ? `<a class="btnSecondary" href="${emailHref}" onclick="event.stopPropagation();">Email</a>` : ``}
              ${phoneHref ? `<a class="btnSecondary" href="${phoneHref}" onclick="event.stopPropagation();">Call/Text</a>` : ``}
              <span class="teamCta" style="margin-left:auto;">View roster →</span>
            </div>
          </div>
        </div>
      `;

      grid.appendChild(a);
    }

    if (!teams.length) {
      grid.innerHTML = `<p class="muted">No teams found. Check your Teams CSV headers.</p>`;
      return;
    }

    // Helpful QA message for missing coach fields
    const missingCoach = teams.filter(t => !t.coachName || (!t.coachEmail && !t.coachPhone));
    if (missingCoach.length) {
      msg.textContent = `Note: ${missingCoach.length} team(s) are missing coach contact info in the Teams sheet.`;
    }
  }

  (async function init(){
    try {
      const csv = await fetchCsv(window.SHEET?.TEAMS_CSV_URL);
      const rows = parseCsv(csv);
      renderContacts(rows);
    } catch (err) {
      console.error(err);
      alert("Contacts page error: check TEAMS_CSV_URL in data.js and make sure the Teams tab is published to CSV.");
    }
  })();
</script>

<script src="./nav.js"></script>
</body>
</html>

