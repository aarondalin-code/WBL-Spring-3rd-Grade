<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home • WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl2026" />
</head>

<body class="watermarkPage homePage hasHamburger">
<header class="siteHeader">
  <div class="navWrap">
    <button
      class="navToggle"
      type="button"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="siteNav"
    >
      <span></span><span></span><span></span>
    </button>

    <div class="navOverlay" aria-hidden="true"></div>

    <nav class="nav" id="siteNav">
      <a href="./" class="active">Home</a>
      <a href="./schedule.html">Schedule/Scores</a>
      <a href="./standings.html">Standings</a>
      <a href="./playoffs.html">Playoffs</a>
      <a href="./teams.html">Teams</a>
      <a href="./rules.html">Rules</a>
      <a href="./contacts.html">Contacts</a>
      <a href="./gallery.html">Gallery</a>
      <a href="./uploads.html">Uploads</a>
    </nav>
  </div>

  <div class="brandCenter">
    <img src="./logo.png" alt="WBL Logo" class="logoImage" />
    <h1>WBL 3rd Grade 2026</h1>
    <div class="tagline">Spring Season</div>
  </div>
</header>

<main class="wrap">
  <section class="docSection">

    <!-- Welcome / Season Snapshot -->
    <div class="standingsHeaderCard">
      <div class="standingsHeaderTitle">Welcome</div>
      <div class="standingsHeaderSub muted">
        10 teams • Round-robin regular season • Playoffs + Consolation
      </div>
      <div class="standingsHeaderMeta muted small" id="homeUpdated"></div>
    </div>

    <!-- This Week + Last Week -->
    <div class="card" style="margin-top:14px;">
      <div class="cardBody">
        <h2 style="margin:0 0 8px 0;">This Week</h2>
        <div id="thisWeekGames"></div>
        <p id="thisWeekMsg" class="muted small" style="margin-top:10px;"></p>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="cardBody">
        <h2 style="margin:0 0 8px 0;">Last Week Results</h2>
        <div id="lastWeekFinals"></div>
        <p id="lastWeekMsg" class="muted small" style="margin-top:10px;"></p>
      </div>
    </div>

    <!-- Players of the Week -->
    <div class="card" style="margin-top:14px;">
      <div class="cardBody">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px;">
          <h2 style="margin:0;">Players of the Week</h2>
          <div class="muted small" id="powWeekLabel"></div>
        </div>
        <div id="powGrid" style="margin-top:10px;"></div>
        <p id="powMsg" class="muted small" style="margin-top:10px;"></p>
      </div>
    </div>

    <!-- Team Links -->
    <div class="card" style="margin-top:14px;">
      <div class="cardBody">
        <h2 style="margin:0 0 8px 0;">Teams</h2>
        <div id="teamGrid"></div>
      </div>
    </div>

    <!-- Park Map -->
    <div class="card" style="margin-top:14px;">
      <div class="cardBody">
        <h2 style="margin:0 0 8px 0;">Park Map (T3, T4, T5)</h2>
        <p class="muted small" style="margin:0 0 10px 0;">
          Save this map — it helps on game days.
        </p>
        <img
          src="./park-map.jpg"
          alt="Park map showing fields T3, T4, T5"
          style="width:100%; max-width:900px; border-radius:12px;"
          onerror="this.style.display='none';"
        />
        <p class="muted small" id="mapMsg" style="margin-top:10px;"></p>
      </div>
    </div>

    <p id="homeMsg" class="muted small" style="margin-top:12px;"></p>
  </section>
</main>

<script src="./data.js"></script>

<script>
  const homeUpdated = document.getElementById("homeUpdated");
  const homeMsg = document.getElementById("homeMsg");

  const thisWeekGamesEl = document.getElementById("thisWeekGames");
  const thisWeekMsgEl = document.getElementById("thisWeekMsg");

  const lastWeekFinalsEl = document.getElementById("lastWeekFinals");
  const lastWeekMsgEl = document.getElementById("lastWeekMsg");

  const powGridEl = document.getElementById("powGrid");
  const powMsgEl = document.getElementById("powMsg");
  const powWeekLabelEl = document.getElementById("powWeekLabel");

  const teamGridEl = document.getElementById("teamGrid");
  const mapMsgEl = document.getElementById("mapMsg");

  function safe(v){ return String(v ?? "").trim(); }
  function normalizeKey(s){ return safe(s).toLowerCase(); }

  function isFinal(status){
    const s = safe(status).toLowerCase();
    return s === "final" || s.startsWith("final");
  }

  function toNum(x){
    const n = Number(safe(x));
    return Number.isFinite(n) ? n : null;
  }

  async function fetchCsv(url) {
    if (!url) throw new Error("Missing CSV URL in data.js");
    const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url + bust, { cache: "no-store" });
    if (!res.ok) throw new Error(`Failed to fetch CSV (${res.status})`);
    return await res.text();
  }

  // Robust CSV parser (quoted commas safe) + BOM strip
  function parseCsv(text) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      const next = text[i + 1];

      if (ch === '"') {
        if (inQuotes && next === '"') { cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }

      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur = "";
        if (row.some(v => safe(v) !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur);
    if (row.some(v => safe(v) !== "")) rows.push(row);

    const headers = (rows.shift() || []).map((h) => {
      let key = safe(h).replace(/\s+/g, "");
      key = key.replace(/^\uFEFF/, "");
      return key;
    });

    return rows
      .filter(r => r.some(x => safe(x) !== ""))
      .map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = safe(r[idx]));
        return obj;
      });
  }

  // Date helpers: your sheet likely uses YYYY-MM-DD which sorts correctly as a string
  function isISODate(s){ return /^\d{4}-\d{2}-\d{2}$/.test(safe(s)); }
  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function teamLink(teamName, teamNameToSlug){
    const name = safe(teamName) || "TBD";
    const slug = teamNameToSlug.get(normalizeKey(name));
    if (!slug) return `<span>${name}</span>`;
    return `<a class="teamLinkInline" href="./team.html?team=${encodeURIComponent(slug)}">${name}</a>`;
  }

  function gameRowCard(g, teamNameToSlug){
    const date = safe(g.Date);
    const time = safe(g.Time);
    const field = safe(g.Field);
    const aName = safe(g.TeamA);
    const bName = safe(g.TeamB);

    const final = isFinal(g.Status);
    const sA = toNum(g.ScoreA);
    const sB = toNum(g.ScoreB);
    const score = (final && sA !== null && sB !== null) ? `${sA}-${sB}` : "";

    const metaParts = [];
    if (time) metaParts.push(time);
    if (field) metaParts.push(field);

    return `
      <div class="card" style="margin-top:10px;">
        <div class="cardBody">
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
            <div>
              <div style="font-weight:900;">
                ${teamLink(aName, teamNameToSlug)}
                <span class="vsSep">vs</span>
                ${teamLink(bName, teamNameToSlug)}
              </div>
              <div class="muted small" style="margin-top:4px;">${metaParts.join(" • ")}</div>
            </div>
            <div style="text-align:right;">
              <div class="muted small">${final ? "Final" : (safe(g.Status) || "Scheduled")}</div>
              <div style="font-weight:900; font-size:18px; margin-top:2px;">${score}</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderTeamGrid(teams){
    // Simple grid without relying on new CSS
    const items = teams.map(t => {
      const logo = safe(t.TeamLogo) || window.DEFAULT_TEAM_LOGO || "./logo.png";
      return `
        <a href="./team.html?team=${encodeURIComponent(t.TeamSlug)}"
           style="display:flex; gap:10px; align-items:center; padding:10px; border-radius:12px; text-decoration:none;">
          <img src="${logo}" alt="${t.TeamName} logo"
               style="width:42px; height:42px; object-fit:cover; border-radius:10px;"
               onerror="this.onerror=null; this.src='${window.DEFAULT_TEAM_LOGO || "./logo.png"}';">
          <div style="font-weight:900;">${t.TeamName}</div>
        </a>
      `;
    }).join("");

    teamGridEl.innerHTML = `
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:10px;">
        ${items}
      </div>
      <p class="muted small" style="margin-top:10px;">
        Or view the full <a href="./teams.html">Teams page</a>.
      </p>
    `;
  }

  function renderPlayersOfWeek(rows, rosterByKey, teamNameToSlug, weekLabel){
    powWeekLabelEl.textContent = weekLabel ? weekLabel : "";

    if (!rows.length) {
      powGridEl.innerHTML = "";
      powMsgEl.textContent = "No Players of the Week posted yet.";
      return;
    }

    // Ensure one per team (latest wins if duplicates)
    const byTeam = new Map();
    for (const r of rows) {
      const tn = safe(r.TeamName);
      if (!tn) continue;
      byTeam.set(normalizeKey(tn), r);
    }

    const cards = Array.from(byTeam.values()).map(r => {
      const teamName = safe(r.TeamName);
      const slug = teamNameToSlug.get(normalizeKey(teamName));
      const playerId = safe(r.PlayerID);
      const blurb = safe(r.Blurb);
      const coach = safe(r.CoachName);

      const rosterKey = `${slug || ""}__${playerId}`;
      const roster = rosterByKey.get(rosterKey);

      const playerName = roster ? safe(roster.Name) : "(Player not found)";
      const photo = roster ? safe(roster.PhotoURL) : "";
      const imgSrc = photo || window.DEFAULT_PLAYER_PHOTO || "./logo.png";

      return `
        <div style="border-radius:14px; padding:12px; border:1px solid rgba(0,0,0,0.08);">
          <div style="display:flex; gap:12px; align-items:flex-start;">
            <img src="${imgSrc}" alt="${playerName}"
                 style="width:72px; height:72px; object-fit:cover; border-radius:12px;"
                 onerror="this.onerror=null; this.src='${window.DEFAULT_PLAYER_PHOTO || "./logo.png"}';">
            <div style="flex:1;">
              <div style="font-weight:900;">${playerName}</div>
              <div class="muted small" style="margin-top:2px;">
                ${slug ? `<a href="./team.html?team=${encodeURIComponent(slug)}">${teamName}</a>` : teamName}
              </div>
            </div>
          </div>
          <div style="margin-top:10px;">${blurb ? blurb : "<span class='muted'>Blurb coming soon.</span>"}</div>
          ${coach ? `<div class="muted small" style="margin-top:8px;">— ${coach}</div>` : ""}
        </div>
      `;
    }).join("");

    powGridEl.innerHTML = `
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(240px, 1fr)); gap:12px; margin-top:8px;">
        ${cards}
      </div>
    `;

    powMsgEl.textContent = "";
  }

  async function init(){
    homeUpdated.textContent = `Last updated: ${new Date().toLocaleString()}`;
    homeMsg.textContent = "";
    mapMsgEl.textContent = "";

    // Load Teams
    const teamsCsv = await fetchCsv(window.SHEET?.TEAMS_CSV_URL);
    const teamRows = parseCsv(teamsCsv);

    const teams = teamRows
      .map(r => ({
        TeamName: safe(r.TeamName),
        TeamSlug: safe(r.TeamSlug),
        TeamLogo: safe(r.TeamLogo)
      }))
      .filter(t => t.TeamName && t.TeamSlug);

    const teamNameToSlug = new Map();
    for (const t of teams) teamNameToSlug.set(normalizeKey(t.TeamName), t.TeamSlug);

    renderTeamGrid(teams);

    // Load Games
    const gamesCsv = await fetchCsv(window.SHEET?.GAMES_CSV_URL);
    const gameRows = parseCsv(gamesCsv);

    // Upcoming: next date >= today (ISO string compare works if Date is YYYY-MM-DD)
    const today = todayISO();
    const datedGames = gameRows.filter(g => isISODate(g.Date));
    const futureGames = datedGames.filter(g => safe(g.Date) >= today);

    let nextDate = null;
    if (futureGames.length) {
      nextDate = futureGames.map(g => safe(g.Date)).sort()[0];
    }

    if (nextDate) {
      const thisWeeks = futureGames.filter(g => safe(g.Date) === nextDate);
      // Sort by Time, then Field
      thisWeeks.sort((a,b) => safe(a.Time).localeCompare(safe(b.Time)) || safe(a.Field).localeCompare(safe(b.Field)));
      thisWeekGamesEl.innerHTML = `<div class="muted small" style="margin-bottom:6px;">${nextDate}</div>` +
        thisWeeks.map(g => gameRowCard(g, teamNameToSlug)).join("");
      thisWeekMsgEl.textContent = "";
    } else {
      thisWeekGamesEl.innerHTML = "";
      thisWeekMsgEl.textContent = "No upcoming games found.";
    }

    // Last week finals: most recent date that has any Final games
    const finals = datedGames.filter(g => isFinal(g.Status));
    let lastFinalDate = null;
    if (finals.length) {
      lastFinalDate = finals.map(g => safe(g.Date)).sort().slice(-1)[0];
    }

    if (lastFinalDate) {
      const lastFinals = finals.filter(g => safe(g.Date) === lastFinalDate);
      lastFinals.sort((a,b) => safe(a.Time).localeCompare(safe(b.Time)) || safe(a.Field).localeCompare(safe(b.Field)));
      lastWeekFinalsEl.innerHTML = `<div class="muted small" style="margin-bottom:6px;">${lastFinalDate}</div>` +
        lastFinals.map(g => gameRowCard(g, teamNameToSlug)).join("");
      lastWeekMsgEl.textContent = "";
    } else {
      lastWeekFinalsEl.innerHTML = "";
      lastWeekMsgEl.textContent = "No final scores yet.";
    }

    // Load Roster (for Player cards)
    const rosterCsv = await fetchCsv(window.SHEET?.ROSTER_CSV_URL);
    const rosterRows = parseCsv(rosterCsv);

    // Build roster map by (TeamSlug + PlayerID)
    const rosterByKey = new Map();
    for (const r of rosterRows) {
      const teamSlug = safe(r.TeamSlug);
      const playerId = safe(r.PlayerID);
      if (!teamSlug || !playerId) continue;
      rosterByKey.set(`${teamSlug}__${playerId}`, r);
    }

    // Load Players of Week
    const powUrl = window.SHEET?.PLAYERS_OF_WEEK_CSV_URL;
    if (!powUrl || powUrl.includes("PASTE_GID_HERE")) {
      powMsgEl.textContent = "Players of the Week feed not connected yet (missing gid in data.js).";
      return;
    }

    const powCsv = await fetchCsv(powUrl);
    const powRowsAll = parseCsv(powCsv);

    // Determine latest week by WeekDate (preferred); fallback to Week text
    const withDates = powRowsAll.filter(r => isISODate(r.WeekDate));
    let latestDate = null;

    if (withDates.length) {
      latestDate = withDates.map(r => safe(r.WeekDate)).sort().slice(-1)[0];
    }

    let powRows = [];
    let weekLabel = "";

    if (latestDate) {
      powRows = withDates.filter(r => safe(r.WeekDate) === latestDate);
      const weekText = safe(powRows[0]?.Week);
      weekLabel = weekText ? `${weekText} • ${latestDate}` : latestDate;
    } else {
      // Fallback: choose the last non-empty Week value lexicographically
      const weeks = powRowsAll.map(r => safe(r.Week)).filter(Boolean).sort();
      const latestWeek = weeks.length ? weeks[weeks.length - 1] : "";
      powRows = latestWeek ? powRowsAll.filter(r => safe(r.Week) === latestWeek) : [];
      weekLabel = latestWeek;
    }

    renderPlayersOfWeek(powRows, rosterByKey, teamNameToSlug, weekLabel);

    // Park map note if missing
    mapMsgEl.textContent = "If the map image does not appear, add park-map.jpg to the repo root (or update the path).";
  }

  init().catch(err => {
    console.error(err);
    homeMsg.textContent = "Home page error: " + err.message;
  });
</script>

<script src="./nav.js"></script>
</body>
</html>
