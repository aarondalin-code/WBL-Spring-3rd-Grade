<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WBL 3rd Grade 2026</title>
  <link rel="stylesheet" href="./styles.css?v=wbl-home-1" />
</head>

<body class="watermarkPage hasHamburger">
  <header class="siteHeader">
    <div class="navWrap">
      <button class="navToggle" type="button" aria-label="Open menu" aria-expanded="false" aria-controls="siteNav">
        <span></span><span></span><span></span>
      </button>

      <div class="navOverlay" aria-hidden="true"></div>

      <nav class="nav" id="siteNav">
        <a href="./" class="active">Home</a>
        <a href="./schedule.html">Schedule/Scores</a>
        <a href="./standings.html">Standings</a>
        <a href="./playoffs.html">Playoffs</a>
        <a href="./teams.html">Teams</a>
        <a href="./rules.html">Rules</a>
        <a href="./contacts.html">Contacts</a>
        <a href="./gallery.html">Gallery</a>
        <a href="./uploads.html">Uploads</a>
      </nav>
    </div>

    <div class="brandCenter">
      <img src="./logo.png" alt="WBL Logo" class="logoImage" />
      <h1>WBL 3rd Grade 2026</h1>
      <div class="tagline">Spring League Central</div>
    </div>
  </header>

  <main class="wrap">

    <!-- Quick links / Hero -->
    <section class="docSection">
      <div class="card">
        <div class="cardBody">
          <div class="homeHeroRow">
            <div>
              <div class="muted small">Welcome</div>
              <h2 style="margin:6px 0 8px;">Weekly schedule, standings, highlights & Players of the Week</h2>
              <div class="muted">
                Games Saturdays at <strong>10:00 AM</strong> and <strong>12:15 PM</strong> on fields <strong>T3, T4, T5</strong>.
              </div>
            </div>

            <div class="homeHeroBtns">
              <a class="btnPrimary" href="./schedule.html">This Week’s Games</a>
              <a class="btnSecondary" href="./standings.html">Standings</a>
              <a class="btnSecondary" href="./uploads.html">Upload Photos/Videos</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- This week + last week -->
    <section class="docSection">
      <div class="homeTwoCol">
        <div class="card">
          <div class="cardBody">
            <div class="homeSectionHead">
              <h3 style="margin:0;">This Week</h3>
              <a class="linkPill" href="./schedule.html">Full Schedule →</a>
            </div>
            <div id="thisWeekGames" class="muted small">Loading…</div>
          </div>
        </div>

        <div class="card">
          <div class="cardBody">
            <div class="homeSectionHead">
              <h3 style="margin:0;">Last Week (Finals)</h3>
              <a class="linkPill" href="./schedule.html">Scores →</a>
            </div>
            <div id="lastWeekFinals" class="muted small">Loading…</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Standings snapshot -->
    <section class="docSection">
      <div class="card">
        <div class="cardBody">
          <div class="homeSectionHead">
            <h3 style="margin:0;">Standings Snapshot (Top 4)</h3>
            <a class="linkPill" href="./standings.html">View Full Standings →</a>
          </div>

          <div class="tableScroll" style="margin-top:10px;">
            <table class="standingsTable" id="standingsMini">
              <thead>
                <tr>
                  <th class="num">#</th>
                  <th>Team</th>
                  <th class="num">W</th>
                  <th class="num">L</th>
                  <th class="num">T</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <p id="standingsMiniMsg" class="muted small" style="margin-top:10px;"></p>
        </div>
      </div>
    </section>

    <!-- Players of the Week -->
    <section class="docSection">
      <div class="card">
        <div class="cardBody">
          <div class="homeSectionHead">
            <div>
              <h3 style="margin:0;">Players of the Week</h3>
              <div class="muted small">Updated weekly — one player per team.</div>
            </div>
          </div>

          <div id="potwGrid" class="potwGrid" style="margin-top:12px;"></div>
          <p id="potwMsg" class="muted small" style="margin-top:10px;"></p>
        </div>
      </div>
    </section>

    <!-- Teams (compact) -->
    <section class="docSection">
      <h2 style="margin-bottom:10px;">Teams</h2>
      <div class="card">
        <div class="cardBody">
          <div id="teamsGridHome" class="teamsGrid"></div>
        </div>
      </div>
    </section>

    <!-- Park map -->
    <section class="docSection">
      <h2 style="margin-bottom:10px;">Park Map</h2>
      <div class="card">
        <div class="cardBody">
          <div class="muted small">Fields: T3, T4, T5</div>
          <div class="homeMapWrap" style="margin-top:10px;">
            <img id="parkMapImg" alt="Park Map" />
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Modal (reused for Players of Week) -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modalClose" id="modalCloseBtn" type="button">✕</button>
      <div id="modalContent"></div>
    </div>
  </div>

  <script src="./data.js"></script>
  <script>
    function safe(v){ return String(v ?? "").trim(); }
    function isFinal(status){ return safe(status).toLowerCase() === "final"; }

    function parseDateLoose(s){
      s = safe(s);
      if (!s) return null;
      // Try native first
      const d1 = new Date(s);
      if (!isNaN(d1.getTime())) return d1;

      // Try M/D/YYYY
      const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (m){
        const mm = Number(m[1]) - 1, dd = Number(m[2]), yy = Number(m[3]);
        const d2 = new Date(yy, mm, dd);
        return isNaN(d2.getTime()) ? null : d2;
      }
      return null;
    }

    async function fetchCsv(url){
      if (!url) throw new Error("Missing CSV URL in data.js");
      const bust = (url.includes("?") ? "&" : "?") + "t=" + Date.now();
      const res = await fetch(url + bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch CSV (${res.status})`);
      return await res.text();
    }

    function parseCsv(text){
      const rows = [];
      let row = [], cur = "", inQuotes = false;

      for (let i=0;i<text.length;i++){
        const ch = text[i], next = text[i+1];
        if (ch === '"'){
          if (inQuotes && next === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
          continue;
        }
        if (!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }
        if (!inQuotes && (ch === "\n" || ch === "\r")){
          if (ch === "\r" && next === "\n") i++;
          row.push(cur); cur="";
          if (row.some(v => safe(v)!=="")) rows.push(row);
          row=[]; continue;
        }
        cur += ch;
      }
      row.push(cur);
      if (row.some(v => safe(v)!=="")) rows.push(row);

      const headers = (rows.shift()||[]).map(h => safe(h).replace(/\s+/g,""));
      return rows.map(r => {
        const o = {};
        headers.forEach((h,idx)=> o[h]=safe(r[idx]));
        return o;
      });
    }

    // Modal
    const overlay = document.getElementById("modalOverlay");
    const modalContent = document.getElementById("modalContent");
    const closeBtn = document.getElementById("modalCloseBtn");

    function openModal(html){
      modalContent.innerHTML = html;
      overlay.classList.add("open");
      document.body.classList.add("noScroll");
      overlay.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      overlay.classList.remove("open");
      document.body.classList.remove("noScroll");
      overlay.setAttribute("aria-hidden","true");
      modalContent.innerHTML = "";
    }
    closeBtn.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e)=>{ if (e.target === overlay) closeModal(); });
    document.addEventListener("keydown",(e)=>{ if (e.key === "Escape") closeModal(); });

    function renderPlayerModal(player){
      const name = safe(player.PlayerName || player.Name || "Player");
      const team = safe(player.Team || player.TeamName || "");
      const num  = safe(player.Number);
      const photo = safe(player.PhotoURL) || (window.DEFAULT_PLAYER_PHOTO || "./logo.png");
      const blurb = safe(player.Blurb || player.Why || player.Reason || player.Notes || "");

      const lines = [];
      if (team) lines.push(`<div class="profileLine"><span class="profileKey">Team</span><span class="profileVal">${team}</span></div>`);
      if (num)  lines.push(`<div class="profileLine"><span class="profileKey">Number</span><span class="profileVal">#${num}</span></div>`);

      openModal(`
        <div class="profileHeader">
          <div class="profilePhoto">
            <img src="${photo}" alt="${name}" onerror="this.onerror=null; this.src='${window.DEFAULT_PLAYER_PHOTO || "./logo.png"}';">
          </div>
          <div>
            <h3 id="modalTitle" class="profileName">${name}</h3>
            ${lines.length ? `<div class="profileLines" style="margin-top:12px;">${lines.join("")}</div>` : ""}
            ${blurb ? `<div class="card" style="margin-top:12px;"><div class="cardBody"><div class="muted small">Coach’s Note</div><div style="margin-top:6px;">${blurb}</div></div></div>` : ""}
          </div>
        </div>
      `);
    }

    function fmtGameRow(g){
      const date = safe(g.Date);
      const time = safe(g.Time);
      const field = safe(g.Field);
      const a = safe(g.TeamA);
      const b = safe(g.TeamB);
      const sa = safe(g.ScoreA);
      const sb = safe(g.ScoreB);
      const status = safe(g.Status);

      const score = isFinal(status) ? `<strong>${sa}-${sb}</strong>` : "";
      const statusTxt = isFinal(status) ? `<span class="pillFinal">Final</span>` : `<span class="muted small">Scheduled</span>`;
      return `
        <div class="homeGameRow">
          <div class="homeGameMeta muted small">${date}${time ? " • " + time : ""}${field ? " • " + field : ""}</div>
          <div class="homeGameMain">
            <div class="homeGameTeams">${a} <span class="muted">vs</span> ${b}</div>
            <div class="homeGameRight">${score} ${statusTxt}</div>
          </div>
        </div>
      `;
    }

    function startOfWeekSatAnchor(){
      // Anchor by Saturday of current week (or next Saturday if earlier in week)
      const now = new Date();
      const day = now.getDay(); // 0 Sun ... 6 Sat
      const daysUntilSat = (6 - day + 7) % 7;
      const sat = new Date(now.getFullYear(), now.getMonth(), now.getDate() + daysUntilSat);
      sat.setHours(0,0,0,0);
      return sat;
    }

    async function initHome(){
      // Park map
      const mapEl = document.getElementById("parkMapImg");
      mapEl.src = window.PARK_MAP_IMG || "./park-map.jpg";
      mapEl.onerror = () => { mapEl.style.display = "none"; };

      // Teams grid (from Teams CSV)
      try{
        const teamsCsv = await fetchCsv(window.SHEET?.TEAMS_CSV_URL);
        const teams = parseCsv(teamsCsv);
        const grid = document.getElementById("teamsGridHome");
        grid.innerHTML = "";
        teams
          .map(t => ({ name: safe(t.TeamName || t.Team), slug: safe(t.TeamSlug || t.Slug) }))
          .filter(t => t.name && t.slug)
          .sort((a,b)=> a.name.localeCompare(b.name))
          .forEach(t=>{
            const a = document.createElement("a");
            a.className = "teamTile";
            a.href = `./team.html?team=${encodeURIComponent(t.slug)}`;
            a.textContent = t.name;
            grid.appendChild(a);
          });
      } catch(e){
        // ok to fail silently-ish
        console.error(e);
      }

      // Games (This week + Last week + Standings mini)
      const gamesCsv = await fetchCsv(window.SHEET?.GAMES_CSV_URL);
      const games = parseCsv(gamesCsv);

      // Partition games by date around “this Saturday”
      const thisSat = startOfWeekSatAnchor();
      const lastSat = new Date(thisSat.getFullYear(), thisSat.getMonth(), thisSat.getDate() - 7);

      const thisWeek = [];
      const lastWeekFinals = [];

      for (const g of games){
        const d = parseDateLoose(g.Date);
        if (!d) continue;
        d.setHours(0,0,0,0);

        if (d.getTime() === thisSat.getTime()){
          thisWeek.push(g);
        }
        if (d.getTime() === lastSat.getTime() && isFinal(g.Status)){
          lastWeekFinals.push(g);
        }
      }

      const thisEl = document.getElementById("thisWeekGames");
      thisEl.innerHTML = thisWeek.length ? thisWeek.map(fmtGameRow).join("") : `<div class="muted small">No games found for this Saturday yet.</div>`;

      const lastEl = document.getElementById("lastWeekFinals");
      lastEl.innerHTML = lastWeekFinals.length ? lastWeekFinals.map(fmtGameRow).join("") : `<div class="muted small">No final games from last Saturday yet.</div>`;

      // Standings snapshot from Final games
      const teamsSet = new Set();
      games.forEach(g => { if (safe(g.TeamA)) teamsSet.add(safe(g.TeamA)); if (safe(g.TeamB)) teamsSet.add(safe(g.TeamB)); });

      const table = new Map();
      for (const t of teamsSet) table.set(t, { team:t, W:0, L:0, T:0 });

      function toNum(x){
        const n = Number(safe(x));
        return Number.isFinite(n) ? n : null;
      }

      let finalsCount = 0;
      for (const g of games){
        if (!isFinal(g.Status)) continue;
        const a = safe(g.TeamA), b = safe(g.TeamB);
        const sa = toNum(g.ScoreA), sb = toNum(g.ScoreB);
        if (!a || !b || sa===null || sb===null) continue;

        if (!table.has(a)) table.set(a,{team:a,W:0,L:0,T:0});
        if (!table.has(b)) table.set(b,{team:b,W:0,L:0,T:0});

        if (sa > sb){ table.get(a).W++; table.get(b).L++; }
        else if (sb > sa){ table.get(b).W++; table.get(a).L++; }
        else { table.get(a).T++; table.get(b).T++; }

        finalsCount++;
      }

      const rows = Array.from(table.values()).sort((x,y)=>{
        if (y.W !== x.W) return y.W - x.W;
        if (x.L !== y.L) return x.L - y.L;
        if (y.T !== x.T) return y.T - x.T;
        return x.team.localeCompare(y.team);
      });

      const miniBody = document.querySelector("#standingsMini tbody");
      miniBody.innerHTML = "";
      rows.slice(0,4).forEach((r,idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="num">${idx+1}</td>
          <td>${r.team}</td>
          <td class="num">${r.W}</td>
          <td class="num">${r.L}</td>
          <td class="num">${r.T}</td>
        `;
        miniBody.appendChild(tr);
      });

      document.getElementById("standingsMiniMsg").textContent =
        finalsCount ? `Based on ${finalsCount} final game(s).` : `No final games yet — standings will appear once games are marked Final.`;

      // Players of the Week (2 rows of 5)
      const potwGrid = document.getElementById("potwGrid");
      const potwMsg = document.getElementById("potwMsg");
      potwGrid.innerHTML = "";

      try{
        const potwCsv = await fetchCsv(window.SHEET?.PLAYERS_OF_WEEK_CSV_URL);
        const potw = parseCsv(potwCsv);

        // Expect columns like: Team, PlayerID, Name/PlayerName, Blurb/Why, PhotoURL (optional)
        const players = potw
          .map(r => ({
            Team: safe(r.Team),
            PlayerID: safe(r.PlayerID),
            PlayerName: safe(r.PlayerName || r.Name),
            PhotoURL: safe(r.PhotoURL),
            Blurb: safe(r.Blurb || r.Why || r.Reason || r.Notes)
          }))
          .filter(p => p.Team && p.PlayerName);

        // If your sheet includes all 10, this will show 10 (2x5).
        players.slice(0,10).forEach(p=>{
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "potwCardBtn";

          const photo = p.PhotoURL || (window.DEFAULT_PLAYER_PHOTO || "./logo.png");

          btn.innerHTML = `
            <img class="potwPhoto" src="${photo}" alt="${p.PlayerName}"
                 onerror="this.onerror=null; this.src='${window.DEFAULT_PLAYER_PHOTO || "./logo.png"}';">
            <div class="potwText">
              <div class="potwName">${p.PlayerName}</div>
              <div class="potwTeam muted small">${p.Team}</div>
              <div class="potwLink">View →</div>
            </div>
          `;

          btn.addEventListener("click", ()=> renderPlayerModal(p));
          potwGrid.appendChild(btn);
        });

        potwMsg.textContent = players.length ? "" : "No Players of the Week yet.";
      } catch(e){
        console.error(e);
        potwMsg.textContent = "Players of the Week unavailable right now.";
      }
    }

    initHome().catch(err => console.error(err));
  </script>

  <script src="./nav.js"></script>
</body>
</html>

